(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const v={customers:[],expenses:[],campaigns:[],leads:[]},h={};async function Pe(){var t;try{const e=await fetch("/customers");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();v.customers=n.map(a=>({id:a.id,name:a.name||"",plan:a.plan||"starter",mrr:a.mrr||0,initialFee:a.initial_fee||0,operationFee:a.operation_fee||0,assignee:a.assignee||"",hours:a.hours||0,region:a.region||"",industry:a.industry||"",channel:a.channel||"",status:a.status||"active",startDate:a.contract_date||new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),healthScore:a.health_score||70,lastLogin:a.last_login||new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),supportTickets:a.support_tickets||0,npsScore:a.nps_score||7,usageRate:a.usage_rate||50,churnDate:a.churn_date}));const r=(t=document.querySelector(".nav-tab.active"))==null?void 0:t.getAttribute("data-tab-target");return r==="home"?O():r==="sales"?H():r==="finance"&&V(),!0}catch(e){return console.error("Error loading customers:",e),R("顧客データの読み込みに失敗しました","error"),v.customers=[],!1}}function Oe(){v.customers=[],v.expenses=[{id:1,date:"2025/05/28",name:"LinkedIn広告費",category:"広告宣伝費",subcategory:"SNS広告",amount:2e5,status:"approved"},{id:2,date:"2025/05/25",name:"Google Ads広告費",category:"広告宣伝費",subcategory:"Web広告",amount:15e4,status:"approved"},{id:3,date:"2025/05/24",name:"AWS開発環境構築",category:"研究開発費",subcategory:"開発ツール",amount:85e3,status:"approved"},{id:4,date:"2025/05/23",name:"マーケティング支援業務",category:"業務委託費",subcategory:"マーケティング委託",amount:12e4,status:"approved"},{id:5,date:"2025/05/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:6,date:"2025/05/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:15e5,status:"approved"},{id:7,date:"2025/05/15",name:"新規事業調査費",category:"予備投資費",subcategory:"新規事業開発",amount:25e4,status:"approved"},{id:8,date:"2025/05/10",name:"製品開発費",category:"研究開発費",subcategory:"製品開発",amount:3e5,status:"approved"},{id:9,date:"2025/05/05",name:"エンジニア業務委託",category:"業務委託費",subcategory:"開発委託",amount:45e4,status:"approved"},{id:10,date:"2025/04/25",name:"Facebook広告費",category:"広告宣伝費",subcategory:"SNS広告",amount:12e4,status:"approved"},{id:11,date:"2025/04/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:12,date:"2025/04/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:14e5,status:"approved"},{id:13,date:"2025/04/15",name:"デザイン制作委託",category:"業務委託費",subcategory:"デザイン委託",amount:18e4,status:"approved"},{id:14,date:"2025/04/10",name:"コンテンツ制作費",category:"広告宣伝費",subcategory:"コンテンツマーケティング",amount:25e4,status:"approved"},{id:15,date:"2025/03/25",name:"リスティング広告費",category:"広告宣伝費",subcategory:"Web広告",amount:18e4,status:"approved"},{id:16,date:"2025/03/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:17,date:"2025/03/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:13e5,status:"approved"},{id:18,date:"2025/03/15",name:"イベント出展費",category:"広告宣伝費",subcategory:"イベント・展示会",amount:35e4,status:"approved"},{id:19,date:"2025/03/10",name:"サーバー費用",category:"研究開発費",subcategory:"開発ツール",amount:12e4,status:"approved"}],v.campaigns=[{id:1,name:"春の新規獲得キャンペーン",channel:"Google Ads",budget:5e5,spent:32e4,leads:45,conversions:8,startDate:"2025/04/01",endDate:"2025/05/31",status:"active"},{id:2,name:"LinkedInターゲティング広告",channel:"LinkedIn",budget:3e5,spent:28e4,leads:23,conversions:5,startDate:"2025/05/01",endDate:"2025/06/30",status:"active"},{id:3,name:"メールナーチャリング",channel:"Email",budget:5e4,spent:3e4,leads:120,conversions:12,startDate:"2025/03/01",endDate:"2025/05/31",status:"active"}],v.leads=[{id:1,company:"XYZ株式会社",contact:"鈴木一郎",email:"suzuki@xyz.co.jp",source:"Google Ads",score:85,status:"hot",createdDate:"2025/05/25"},{id:2,company:"123商事",contact:"高橋花子",email:"takahashi@123.co.jp",source:"LinkedIn",score:70,status:"warm",createdDate:"2025/05/24"},{id:3,company:"テクノロジー研究所",contact:"山本太郎",email:"yamamoto@tech.co.jp",source:"Webフォーム",score:60,status:"warm",createdDate:"2025/05/23"},{id:4,company:"グローバル商社",contact:"佐藤次郎",email:"sato@global.co.jp",source:"イベント",score:90,status:"hot",createdDate:"2025/05/22"},{id:5,company:"イノベーション株式会社",contact:"田中美穂",email:"tanaka@innovation.co.jp",source:"紹介",score:40,status:"cold",createdDate:"2025/05/20"}]}function Ie(t,e){const n=document.querySelectorAll(".nav-tab"),r=document.querySelectorAll(".sidebar-icon"),a=document.querySelectorAll(".tab-content");n.forEach(i=>i.classList.remove("active")),r.forEach(i=>i.classList.remove("active")),a.forEach(i=>i.classList.remove("active"));const o=document.getElementById(t);o&&o.classList.add("active");const s=document.querySelector(`.nav-tab[data-tab-target="${t}"]`);s&&s.classList.add("active");const m=document.querySelector(`.sidebar-icon[data-tab-target="${t}"]`);if(m&&m.classList.add("active"),e&&e.classList.contains("sidebar-icon")){const i=document.querySelector(`.nav-tab[data-tab-target="${t}"]`);i&&i.classList.add("active")}if(t==="home")O();else if(t==="sales")H(),ne();else if(t==="marketing")Be();else if(t==="customer-success")ot();else if(t==="finance"){const i=new Date;document.getElementById("balanceViewYear").value=String(i.getFullYear()),document.getElementById("balanceViewMonth").value=String(i.getMonth()+1),V(),me(),h.monthlyBalance||ge(),setTimeout(()=>pe(),100)}else t==="analytics"?gt():t==="subscription"&&(ht(),h.cohortChart||oe())}function O(){const t=v.customers.filter(B=>B.status==="active"),e=t.reduce((B,L)=>B+L.mrr,0),n=e*12,r=t.length;document.getElementById("totalMRR").textContent=`¥${e.toLocaleString()}`,document.getElementById("annualRunRate").textContent=`¥${n.toLocaleString()}`,document.getElementById("subscriberCount").textContent=String(r);const a=new Date,o=a.getMonth(),s=a.getFullYear();let m=0;v.customers.forEach(B=>{const L=new Date(B.startDate.replace(/\//g,"-"));L.getMonth()===o&&L.getFullYear()===s&&B.status==="active"&&(m+=B.mrr)});const i=Math.round(e*.05),f=-Math.round(e*.01),c=-Math.round(e*.02),l=m+i+f+c;document.getElementById("newBusinessMRR").textContent=`¥${m.toLocaleString()}`,document.getElementById("expansionMRR").textContent=`¥${i.toLocaleString()}`,document.getElementById("contractionMRR").textContent=`¥${Math.abs(f).toLocaleString()}`,document.getElementById("churnMRR").textContent=`¥${Math.abs(c).toLocaleString()}`,document.getElementById("reactivationMRR").textContent="¥0",document.getElementById("netMRRChange").textContent=`¥${l.toLocaleString()}`,document.getElementById("netMRRChange").style.color=l>=0?"#00c853":"#ff3b30",document.getElementById("scheduledMRRChange").textContent="¥50,000";const p=e-l,u=p>0?l/p*100:m>0?100:0,d=document.getElementById("mrrChangePercent");d.textContent=`${l>=0?"↑":"↓"} ${Math.abs(u).toFixed(1)}% 前月比`,d.className=`metric-change ${l>=0?"positive":"negative"}`;const y=document.getElementById("arrChange");y.textContent=`${l>=0?"↑":"↓"} ${Math.abs(u).toFixed(1)}% 過去30日間`,y.className=`metric-change ${l>=0?"positive":"negative"}`;const D=v.customers.filter(B=>{const L=new Date(B.startDate.replace(/\//g,"-"));return L.getMonth()===o&&L.getFullYear()===s}).length,w=document.getElementById("subscriberChange");w.textContent=`↑ ${D} 新規`,w.className="metric-change positive",qe(),Le()}function qe(){const t=document.getElementById("topWinsContent"),e=v.customers.filter(n=>n.status==="active").sort((n,r)=>new Date(r.startDate.replace(/\//g,"-")).getTime()-new Date(n.startDate.replace(/\//g,"-")).getTime()).slice(0,3);e.length>0?(t.innerHTML=e.map(n=>`
            <div style="padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${n.name}</strong>
                        <div style="font-size: 12px; color: #6f767e; margin-top: 4px;">
                            ${se(n.plan)} - ¥${n.mrr.toLocaleString()}/月
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6f767e;">
                        ${n.startDate}
                    </div>
                </div>
            </div>
        `).join(""),e.length<3&&(t.innerHTML+=`<div class="no-data" style="padding: 10px 0;">${3-e.length}件以上のデータを追加すると充実します</div>`)):t.innerHTML='<div class="no-data">今週の成果はありません</div>'}function H(){const t=document.getElementById("customerTableBody"),e=document.getElementById("customerSearch").value.toLowerCase(),n=document.getElementById("statusFilter").value,r=document.getElementById("planFilterSales").value,a=v.customers.filter(s=>{const m=s.name.toLowerCase().includes(e),i=!n||s.status===n,f=!r||s.plan===r;return m&&i&&f}),o=document.getElementById("selectAllCustomersCheckbox");if(o&&(o.checked=!1),a.length===0){v.customers.length===0?t.innerHTML='<tr><td colspan="14" class="no-data">顧客データがありません。</td></tr>':t.innerHTML='<tr><td colspan="14" class="no-data">フィルター条件に一致する顧客がいません。</td></tr>',ne();return}t.innerHTML=a.map(s=>`
        <tr data-customer-id="${s.id}">
            <td><input type="checkbox" class="customer-select-checkbox" data-customer-id="${s.id}"></td>
            <td>${s.name}</td>
            <td>${se(s.plan)}</td>
            <td>¥${s.mrr.toLocaleString()}</td>
            <td>¥${s.initialFee.toLocaleString()}</td>
            <td>¥${s.operationFee.toLocaleString()}</td>
            <td>${s.assignee}</td>
            <td>${s.hours}</td>
            <td>${s.region}</td>
            <td>${s.industry}</td>
            <td>${s.channel}</td>
            <td>${Se(s.status)}</td>
            <td>${s.startDate}</td>
            <td>
                <button class="btn btn-secondary btn-show-detail" data-customer-id="${s.id}">詳細</button>
                <button class="btn btn-secondary btn-delete-customer" data-customer-id="${s.id}" style="color: #ff3b30;">削除</button>
            </td>
        </tr>
    `).join(""),ne()}function We(){document.getElementById("addCustomerForm").reset(),document.getElementById("addCustomerModal").classList.add("active")}function Ge(){return v.customers.length===0?1:Math.max(...v.customers.map(t=>t.id))+1}async function Je(){const t={name:document.getElementById("newCustomerName").value,plan:document.getElementById("newCustomerPlan").value,mrr:parseInt(document.getElementById("newCustomerMrr").value)||0,initialFee:parseInt(document.getElementById("newCustomerInitialFee").value)||0,operationFee:parseInt(document.getElementById("newCustomerOperationFee").value)||0,assignee:document.getElementById("newCustomerAssignee").value,hours:parseInt(document.getElementById("newCustomerHours").value)||0,region:document.getElementById("newCustomerRegion").value,industry:document.getElementById("newCustomerIndustry").value,channel:document.getElementById("newCustomerChannel").value,status:"trial",startDate:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),healthScore:70,lastLogin:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),supportTickets:0,npsScore:7,usageRate:50};try{const e=await fetch("/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json(),r={...t,id:n.id};v.customers.push(r),A("addCustomerModal"),H(),O(),V(),R("顧客を追加しました","success")}catch(e){console.error("Error adding customer:",e),R("顧客の追加に失敗しました","error")}}async function _e(t){if(confirm("この顧客を削除してもよろしいですか？"))try{const e=await fetch(`/customers/${t}`,{method:"DELETE"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);v.customers=v.customers.filter(n=>n.id!==t),H(),O(),V(),R("顧客を削除しました","success")}catch(e){console.error("Error deleting customer:",e),R("顧客の削除に失敗しました","error")}}async function Ue(t){if(t.length===0){R("削除する顧客が選択されていません。","error");return}if(confirm(`選択した ${t.length} 件の顧客を削除してもよろしいですか？`))try{const e=t.map(o=>fetch(`/customers/${o}`,{method:"DELETE"})),n=await Promise.allSettled(e);let r=0;n.forEach((o,s)=>{o.status==="fulfilled"&&o.value.ok&&(r++,v.customers=v.customers.filter(m=>m.id!==t[s]))}),H(),O(),V(),r===t.length?R(`${r} 件の顧客を削除しました`,"success"):R(`${r} 件の顧客を削除しました。${t.length-r} 件は削除に失敗しました。`,"warning");const a=document.getElementById("selectAllCustomersCheckbox");a&&(a.checked=!1)}catch(e){console.error("Error deleting customers:",e),R("顧客の削除に失敗しました","error")}}function Ze(t){const e=v.customers.find(n=>n.id===t);if(e){const n=`顧客ID: ${e.id}
会社名: ${e.name}
プラン: ${se(e.plan)}
MRR: ¥${e.mrr.toLocaleString()}
初期費用: ¥${e.initialFee.toLocaleString()}
運用代行費: ¥${e.operationFee.toLocaleString()}
担当者: ${e.assignee}
工数: ${e.hours}h/月
地域: ${e.region}
業界: ${e.industry}
獲得チャネル: ${e.channel}
ステータス: ${e.status}
契約開始日: ${e.startDate}
ヘルススコア: ${e.healthScore}%
最終ログイン: ${e.lastLogin}
サポートチケット: ${e.supportTickets}
NPS: ${e.npsScore}
利用率: ${e.usageRate}%`;alert(n),R(`${e.name}の詳細情報を表示しました (コンソールに詳細)`,"success"),console.log("Customer Details:",e)}else R(`顧客ID ${t} が見つかりません。`,"error")}function Qe(){const e=[["会社名","プラン","月額料金","初期費用","運用代行費","担当者","工数","地域","業界","獲得チャネル","ステータス","契約開始日"].join(",")];v.customers.forEach(o=>{const s=[o.name,se(o.plan),o.mrr,o.initialFee,o.operationFee,o.assignee,o.hours,o.region,o.industry,o.channel,o.status,o.startDate];e.push(s.join(","))});const n=e.join(`
`),r=new Blob(["\uFEFF"+n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(r),a.download=`顧客データ_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),R("顧客データをエクスポートしました","success")}function Xe(){document.getElementById("importModal").classList.add("active");const t=document.getElementById("csvFileInput");t&&(t.value="")}function ve(t){var n;const e=(n=t.target.files)==null?void 0:n[0];if(e&&e.type==="text/csv"){const r=new FileReader;r.onload=a=>{var i,f,c,l,p,u,d,y,D,w,B,L,C;const s=((i=a.target)==null?void 0:i.result).split(`
`).map(E=>E.trim()).filter(E=>E);if(s.length<=1){R("CSVファイルにデータがありません。","error");return}let m=0;for(let E=1;E<s.length;E++){const M=s[E].split(",");if(M.length<12){console.warn(`Skipping row ${E+1} due to insufficient columns: ${s[E]}`);continue}const j={id:Ge(),name:((f=M[0])==null?void 0:f.trim())||"",plan:((c=M[1])==null?void 0:c.trim())||"starter",mrr:parseInt((l=M[2])==null?void 0:l.trim())||0,initialFee:parseInt((p=M[3])==null?void 0:p.trim())||0,operationFee:parseInt((u=M[4])==null?void 0:u.trim())||0,assignee:((d=M[5])==null?void 0:d.trim())||"",hours:parseInt((y=M[6])==null?void 0:y.trim())||0,region:((D=M[7])==null?void 0:D.trim())||"",industry:((w=M[8])==null?void 0:w.trim())||"",channel:((B=M[9])==null?void 0:B.trim())||"",status:((L=M[10])==null?void 0:L.trim())||"trial",startDate:((C=M[11])==null?void 0:C.trim())||new Date().toLocaleDateString("ja-JP").replace(/-/g,"/"),healthScore:70,lastLogin:new Date().toLocaleDateString("ja-JP").replace(/-/g,"/"),supportTickets:0,npsScore:7,usageRate:50};j.name?(v.customers.push(j),m++):console.warn(`Skipping row ${E+1} due to missing name: ${s[E]}`)}A("importModal"),H(),O(),V(),R(`${m}件のデータをインポートしました`,"success")},r.onerror=()=>{R("ファイル読み込みエラー","error")},r.readAsText(e,"UTF-8")}else R("CSVファイルを選択してください","error")}function ne(){const t=document.getElementById("bulkDeleteCustomersButton");if(!t)return;document.querySelectorAll(".customer-select-checkbox:checked").length>0?t.disabled=!1:t.disabled=!0}function Be(){const t=v.leads.length,e=v.campaigns.reduce((o,s)=>o+s.conversions,0),n=v.campaigns.reduce((o,s)=>o+s.spent,0),r=t>0?(e/t*100).toFixed(1):"0",a=t>0?Math.round(n/t):0;document.getElementById("totalLeads").textContent=String(t),document.getElementById("conversionRate").textContent=`${r}%`,document.getElementById("cplValue").textContent=`¥${a.toLocaleString()}`,document.getElementById("totalLeadsChange").textContent="↑ 0% 前月比",document.getElementById("conversionRateChange").textContent="↑ 0% 前月比",document.getElementById("cplValueChange").textContent="↓ 0% 前月比",Ke(),xe()}function Ke(){const t=document.getElementById("campaignList");if(v.campaigns.length===0){t.innerHTML='<div class="no-data">キャンペーンがありません。</div>';return}t.innerHTML=v.campaigns.map(e=>{const n=e.spent>0?((e.conversions*25e3-e.spent)/e.spent*100).toFixed(0):"0",r=e.budget>0?Math.min(100,e.spent/e.budget*100).toFixed(0):"0";return`
            <div class="campaign-card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="font-size: 16px; margin-bottom: 8px;">${e.name}</h4>
                        <div style="font-size: 12px; color: #6f767e;">
                            ${e.channel} | ${e.startDate} - ${e.endDate}
                        </div>
                    </div>
                    <span class="status-badge ${e.status==="active"?"active":"pending"}">${e.status}</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">予算消化</div>
                        <div style="font-weight: 600;">¥${e.spent.toLocaleString()} / ¥${e.budget.toLocaleString()}</div>
                        <div class="progress-bar" style="margin-top: 4px;">
                            <div class="progress-fill" style="width: ${r}%"></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">リード数</div>
                        <div style="font-weight: 600;">${e.leads}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">コンバージョン</div>
                        <div style="font-weight: 600;">${e.conversions}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">ROI</div>
                        <div style="font-weight: 600; color: ${parseFloat(n)>=0?"#00c853":"#ff3b30"};">${n}%</div>
                    </div>
                </div>
            </div>
        `}).join("")}function xe(){const t=document.getElementById("leadTableBody");if(v.leads.length===0){t.innerHTML='<tr><td colspan="8" class="no-data">リードがいません。</td></tr>';return}t.innerHTML=v.leads.map(e=>`
        <tr>
            <td>${e.company}</td>
            <td>${e.contact}</td>
            <td>${e.email}</td>
            <td>${e.source}</td>
            <td>${et(e.score,e.status)}</td>
            <td><span class="status-badge pending">${e.status==="converted"?"商談化済":"新規"}</span></td>
            <td>${e.createdDate}</td>
            <td>
                <button class="btn btn-secondary btn-convert-lead" data-lead-id="${e.id}" ${e.status==="converted"?" disabled":""}>商談化</button>
            </td>
        </tr>
    `).join("")}function et(t,e){return`<span class="lead-score ${e}">${t}</span>`}function tt(t){const e=v.leads.find(n=>n.id===t);e&&e.status!=="converted"?(e.status="converted",R(`${e.company}を商談化しました`,"success"),xe()):e&&e.status==="converted"&&R(`${e.company}は既に商談化されています`,"error")}function nt(){document.getElementById("addCampaignForm").reset(),document.getElementById("campaignStartDate").value=new Date().toISOString().split("T")[0],document.getElementById("addCampaignModal").classList.add("active")}function at(){const t={id:v.campaigns.length>0?Math.max(...v.campaigns.map(e=>e.id))+1:1,name:document.getElementById("campaignName").value,channel:document.getElementById("campaignChannel").value,budget:parseInt(document.getElementById("campaignBudget").value)||0,spent:0,leads:0,conversions:0,startDate:document.getElementById("campaignStartDate").value.replace(/-/g,"/"),endDate:document.getElementById("campaignEndDate").value.replace(/-/g,"/"),status:"active"};v.campaigns.push(t),A("addCampaignModal"),Be(),R("キャンペーンを作成しました","success")}function ot(){const e=v.customers.filter(o=>o.status==="active").map(o=>o.npsScore).filter(o=>typeof o=="number"),n=e.filter(o=>o>=9).length,r=e.filter(o=>o<=6).length,a=e.length>0?Math.round((n-r)/e.length*100):0;document.getElementById("npsScore").textContent=String(a),document.getElementById("avgResponseTime").textContent="2.5h",document.getElementById("csat").textContent="92%",document.getElementById("npsScoreChange").textContent="↑ 0 前四半期比",document.getElementById("avgResponseTimeChange").textContent="↓ 0% 前月比",document.getElementById("csatChange").textContent="↑ 0% 前月比",st(),rt()}function st(){const t=document.getElementById("healthScoreTableBody"),e=v.customers.filter(n=>n.status==="active");if(e.length===0){t.innerHTML='<tr><td colspan="7" class="no-data">アクティブな顧客がいません。</td></tr>';return}t.innerHTML=e.map(n=>{const r=n.healthScore>=80?"healthy":n.healthScore>=60?"at-risk":"critical";return`
            <tr>
                <td>${n.name}</td>
                <td><div class="health-score"><span class="health-dot ${r}"></span>${n.healthScore}%</div></td>
                <td>${n.usageRate}%</td>
                <td>${n.lastLogin}</td>
                <td>${n.supportTickets}</td>
                <td>${n.assignee}</td>
                <td>${r==="at-risk"?"要フォローアップ":r==="critical"?"緊急対応必要":"定期チェック"}</td>
            </tr>
        `}).join("")}function rt(){const t=[{id:1,title:"PQRサービスのヘルススコア改善施策実施",due:"2025/06/10",completed:!1},{id:2,title:"GHIコーポレーションの四半期レビュー",due:"2025/06/15",completed:!1},{id:3,title:"JKLテクノロジーのオンボーディング完了確認",due:"2025/06/01",completed:!0}],e=document.getElementById("csTaskList");if(t.length===0){e.innerHTML='<div class="no-data">タスクがありません。</div>';return}e.innerHTML=t.map(n=>`
        <div class="task-card">
            <input type="checkbox" class="task-checkbox" id="task-${n.id}" ${n.completed?"checked":""} data-task-id="${n.id}">
            <label for="task-${n.id}" style="flex: 1; ${n.completed?"text-decoration: line-through; color: #6f767e;":""}">
                <div>${n.title}</div>
                <div style="font-size: 12px; color: #6f767e; margin-top: 4px;">期限: ${n.due}</div>
            </label>
        </div>
    `).join("")}function ct(t){R(`タスク ${t} のステータスを更新しました`,"success")}function V(t,e){var B,L;const n=new Date,r=t||parseInt((B=document.getElementById("balanceViewYear"))==null?void 0:B.value)||n.getFullYear(),a=e!==null?e:parseInt((L=document.getElementById("balanceViewMonth"))==null?void 0:L.value)-1;let o=0,s=0,m=0,i=0,f=0,c=0;v.customers.forEach(C=>{const E=new Date(C.startDate.replace(/\//g,"-"));E.getMonth()===a&&E.getFullYear()===r&&(o+=C.initialFee,i++),(C.status==="active"||C.status==="churned"&&C.churnDate&&new Date(C.churnDate.replace(/\//g,"-"))>new Date(r,a,1))&&E<=new Date(r,a+1,0)&&(m+=C.mrr,s+=C.operationFee,f++,C.operationFee>0&&c++)});const l=m+o+s,p=v.expenses.filter(C=>{const E=new Date(C.date.replace(/\//g,"-"));return E.getMonth()===a&&E.getFullYear()===r&&C.status==="approved"}),u=p.reduce((C,E)=>C+E.amount,0),d=l-u,y=l>0?(d/l*100).toFixed(1):"0";document.getElementById("monthlyMRRIncome").textContent=`¥${m.toLocaleString()}`,document.getElementById("mrrIncomeDetail").textContent=`アクティブ顧客: ${f}社`,document.getElementById("monthlyInitialFees").textContent=`¥${o.toLocaleString()}`,document.getElementById("initialFeeCount").textContent=`新規${i}件`,document.getElementById("monthlyOperationFees").textContent=`¥${s.toLocaleString()}`,document.getElementById("operationFeeChangeFinance").textContent=`対象顧客: ${c}社`,document.getElementById("monthlyTotalIncome").textContent=`¥${l.toLocaleString()}`,document.getElementById("monthlyTotalExpense").textContent=`¥${u.toLocaleString()}`;const D=document.getElementById("monthlyBalance");D.textContent=`¥${d.toLocaleString()}`,D.className=`metric-value ${d>=0?"":"negative"}`;const w=document.getElementById("balanceChange");return w.textContent=`利益率: ${y}%`,w.className=`metric-change ${d>=0?"positive":"negative"}`,dt(p),lt(l,m,o,s,p),{totalIncome:l,totalExpense:u,balance:d}}function dt(t){const e={};t.forEach(a=>{e[a.category]=(e[a.category]||0)+a.amount});const n=document.getElementById("expenseCategoryBreakdown"),r=t.reduce((a,o)=>a+o.amount,0);if(Object.keys(e).length===0){n.innerHTML='<div class="no-data">今月の経費データがありません。</div>';return}n.innerHTML=Object.entries(e).sort(([,a],[,o])=>o-a).map(([a,o])=>{const s=r>0?(o/r*100).toFixed(1):"0";return`
                <div style="background: #f8f9fb; padding: 16px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6f767e; margin-bottom: 4px;">${a}</div>
                    <div style="font-size: 20px; font-weight: 600; color: #1a1d1f;">¥${o.toLocaleString()}</div>
                    <div style="font-size: 12px; color: #6f767e;">${s}%</div>
                </div>`}).join("")}function lt(t,e,n,r,a){const o=document.getElementById("balanceTableBody"),s=[];e>0&&s.push({name:"月額利用料（MRR）",category:"売上高",income:e,expense:0}),n>0&&s.push({name:"初期導入費用",category:"売上高",income:n,expense:0}),r>0&&s.push({name:"運用代行費",category:"売上高",income:r,expense:0});const m={};a.forEach(c=>{m[c.category]=(m[c.category]||0)+c.amount}),Object.entries(m).forEach(([c,l])=>{s.push({name:c,category:"経費",income:0,expense:l})}),s.length===0?o.innerHTML='<tr><td colspan="5" class="no-data">収支データがありません。</td></tr>':o.innerHTML=s.map(c=>{const l=c.income-c.expense;return`
                <tr>
                    <td>${c.name}</td>
                    <td>${c.category}</td>
                    <td>${c.income>0?`¥${c.income.toLocaleString()}`:"-"}</td>
                    <td>${c.expense>0?`¥${c.expense.toLocaleString()}`:"-"}</td>
                    <td class="${l>=0?"positive":"negative"}">¥${l.toLocaleString()}</td>
                </tr>`}).join("");const i=a.reduce((c,l)=>c+l.amount,0);document.getElementById("totalIncomeFooter").textContent=`¥${t.toLocaleString()}`,document.getElementById("totalExpenseFooter").textContent=`¥${i.toLocaleString()}`;const f=document.getElementById("totalBalanceFooter");f.textContent=`¥${(t-i).toLocaleString()}`,f.className=t-i>=0?"positive":"negative"}function me(){const t=document.getElementById("expenseTableBodyFinance");if(v.expenses.length===0){t.innerHTML='<tr><td colspan="6" class="no-data">経費データがありません。</td></tr>';return}t.innerHTML=v.expenses.sort((e,n)=>new Date(n.date).getTime()-new Date(e.date).getTime()).map(e=>`
        <tr>
            <td>${e.date}</td>
            <td>${e.name}</td>
            <td>${e.category}${e.subcategory?` - ${e.subcategory}`:""}</td>
            <td>¥${e.amount.toLocaleString()}</td>
            <td>${Se(e.status)}</td>
            <td><button class="btn btn-secondary btn-delete-expense" data-expense-id="${e.id}" style="color: #ff3b30;">削除</button></td>
        </tr>
    `).join("")}function it(){document.getElementById("addExpenseFormFinance").reset(),document.getElementById("expenseDate").value=new Date().toISOString().split("T")[0],$e(),document.getElementById("addExpenseModal").classList.add("active")}function ut(){const t={id:v.expenses.length>0?Math.max(...v.expenses.map(e=>e.id))+1:1,date:document.getElementById("expenseDate").value.replace(/-/g,"/"),name:document.getElementById("expenseName").value,category:document.getElementById("expenseCategoryFinance").value,subcategory:document.getElementById("expenseSubcategory").value||"",amount:parseInt(document.getElementById("expenseAmount").value)||0,status:"pending"};if(!t.name||!t.category||isNaN(t.amount)||t.amount<=0){R("必須項目を入力してください。金額は0より大きい値を入力してください。","error");return}v.expenses.push(t),A("addExpenseModal"),me(),V(),R("経費を登録しました","success")}function mt(t){confirm("この経費を削除してもよろしいですか？")&&(v.expenses=v.expenses.filter(e=>e.id!==t),me(),V(),R("経費を削除しました","success"))}function $e(){const t=document.getElementById("expenseCategoryFinance").value,e=document.getElementById("subcategoryGroup"),n=document.getElementById("expenseSubcategory"),r={広告宣伝費:["Web広告","SNS広告","オフライン広告","PR・広報","イベント・展示会","コンテンツマーケティング"],業務委託費:["開発委託","デザイン委託","コンサルティング","マーケティング委託","カスタマーサポート委託","その他委託"],人件費:["役員報酬","正社員給与","契約社員給与","アルバイト給与","賞与","社会保険料","退職金"],研究開発費:["製品開発","技術研究","プロトタイプ制作","特許申請","ライセンス取得","開発ツール"],予備投資費:["設備投資","システム投資","事業拡大準備","新規事業開発","M&A関連","緊急対応費"]};t&&r[t]?(e.style.display="block",n.innerHTML='<option value="">選択してください</option>'+r[t].map(a=>`<option value="${a}">${a}</option>`).join("")):(e.style.display="none",n.innerHTML='<option value="">選択してください</option>',n.value="")}function be(){const t=parseInt(document.getElementById("balanceViewYear").value),e=parseInt(document.getElementById("balanceViewMonth").value)-1;V(t,e),pe()}function gt(){const t=v.customers.filter(d=>d.status==="active"),e=t.reduce((d,y)=>d+y.mrr,0),n=t.length>0?e/t.length:0,r=v.campaigns.reduce((d,y)=>{const D=new Date(y.startDate.replace(/\//g,"-")),w=new Date(y.endDate.replace(/\//g,"-")),B=new Date;return D<=B&&w>=B?d+y.spent/((w.getTime()-D.getTime())/(1e3*3600*24*30)||1):d},0),a=45e4,o=v.customers.filter(d=>{const y=new Date(d.startDate.replace(/\//g,"-")),D=new Date;return y.getFullYear()===D.getFullYear()&&y.getMonth()===D.getMonth()}).length||1,s=(r+a)/o,m=24,i=n*m,f=s>0?i/s:0;document.getElementById("cacValue").textContent=`¥${Math.round(s).toLocaleString()}`,document.getElementById("ltvValue").textContent=`¥${Math.round(i).toLocaleString()}`,document.getElementById("ltvCacRatio").textContent=f.toFixed(1),document.getElementById("cacValueChange").textContent="↓ 0% 前月比",document.getElementById("ltvValueChange").textContent="↑ 0% 前月比",document.getElementById("ltvCacRatioChange").textContent="↑ 0 前月比";const c=t.filter(d=>d.plan==="starter"),l=t.filter(d=>d.plan==="professional"),p=t.filter(d=>d.plan==="enterprise");document.getElementById("starterMetrics").textContent=`¥${c.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("starterMetricsCount").textContent=`顧客数: ${c.length}`,document.getElementById("professionalMetrics").textContent=`¥${l.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("professionalMetricsCount").textContent=`顧客数: ${l.length}`,document.getElementById("enterpriseMetrics").textContent=`¥${p.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("enterpriseMetricsCount").textContent=`顧客数: ${p.length}`;const u=document.getElementById("ltvAnalysisTableBody");if(t.length===0){u.innerHTML='<tr><td colspan="5" class="no-data">アクティブな顧客がいません。</td></tr>';return}u.innerHTML=t.map(d=>{const y=new Date(d.startDate.replace(/\//g,"-")),w=Math.max(0,Math.floor((new Date().getTime()-y.getTime())/(1e3*60*60*24*30.4375))),B=d.mrr*w+d.initialFee,L=d.mrr*m,C=d.healthScore<60?"critical":d.healthScore<80?"at-risk":"healthy",E=C==="critical"?"churned":C==="at-risk"?"pending":"active",M=C==="critical"?"高":C==="at-risk"?"中":"低";return`
            <tr>
                <td>${d.name}</td>
                <td>${w}ヶ月</td>
                <td>¥${B.toLocaleString()}</td>
                <td>¥${L.toLocaleString()}</td>
                <td><span class="status-badge ${E}">${M}</span></td>
            </tr>
        `}).join("")}function pt(){R("レポートを生成中...","success"),setTimeout(()=>R("月次レポートが生成されました","success"),2e3)}function ie(t){R(`${t}レポートをダウンロード中...`,"success")}function ht(){const t=v.customers.filter(c=>c.status==="active"),e=t.reduce((c,l)=>c+l.mrr,0),n=e*12,r=100+(Math.random()*10-5),a=v.customers.filter(c=>{if(c.status!=="churned"||!c.churnDate)return!1;const l=new Date(c.churnDate.replace(/\//g,"-")),p=new Date,u=new Date(p.getFullYear(),p.getMonth()-1,1),d=new Date(p.getFullYear(),p.getMonth(),0);return l>=u&&l<=d}).length,o=v.customers.filter(c=>{const l=new Date(c.startDate.replace(/\//g,"-")),p=new Date,u=new Date(p.getFullYear(),p.getMonth()-1,1);return l<u&&(c.status==="active"||c.status==="churned"&&c.churnDate&&new Date(c.churnDate.replace(/\//g,"-"))>=u)}).length,s=o>0?a/o*100:0,m=t.length>0?e/t.length:0;let i=0;t.forEach(c=>{const l=new Date(c.startDate.replace(/\//g,"-")),p=c.status==="churned"&&c.churnDate?new Date(c.churnDate.replace(/\//g,"-")):new Date;i+=Math.max(0,Math.floor((p.getTime()-l.getTime())/(1e3*60*60*24*30.4375)))});const f=t.length>0?Math.round(i/t.length):0;document.getElementById("subMRR").textContent=`¥${e.toLocaleString()}`,document.getElementById("subARR").textContent=`¥${n.toLocaleString()}`,document.getElementById("nrr").textContent=`${r.toFixed(0)}%`,document.getElementById("monthlyChurnRate").textContent=`${s.toFixed(1)}%`,document.getElementById("arpa").textContent=`¥${Math.round(m).toLocaleString()}`,document.getElementById("avgRetentionMonths").textContent=`${f}ヶ月`,document.getElementById("subMRRChange").textContent="↑ 0% 前月比",document.getElementById("subARRChange").textContent="↑ 0% 前年比",document.getElementById("nrrChange").textContent="↑ 0% 前四半期比",document.getElementById("monthlyChurnRateChange").textContent="↓ 0% 前月比",document.getElementById("arpaChange").textContent="↑ 0% 前月比",document.getElementById("avgRetentionMonthsDetail").textContent="業界平均: 24ヶ月",h.cohortChart&&De(),h.mrrForecastChart&&we()}function Me(){var a,o,s,m;const t=(a=document.getElementById("mrrChart"))==null?void 0:a.getContext("2d");t&&!h.mrr&&(h.mrr=new Chart(t,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const e=(o=document.getElementById("subscribersChart"))==null?void 0:o.getContext("2d");e&&!h.subscribers&&(h.subscribers=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const n=(s=document.getElementById("arrChart"))==null?void 0:s.getContext("2d");n&&!h.arr&&(h.arr=new Chart(n,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const r=(m=document.getElementById("mrrMovementsChart"))==null?void 0:m.getContext("2d");r&&!h.mrrMovements&&(h.mrrMovements=new Chart(r,{type:"bar",data:{labels:[],datasets:[{label:"新規",data:[],backgroundColor:"#00c853"},{label:"拡張",data:[],backgroundColor:"#0066ff"},{label:"解約",data:[],backgroundColor:"#ff3b30"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"}},scales:{x:{stacked:!0},y:{stacked:!0,ticks:{callback:i=>`¥${(Number(i)/1e3).toLocaleString()}k`}}}}}))}function Le(){var c,l,p;if((!h.mrr||!h.subscribers||!h.arr||!h.mrrMovements)&&Me(),!h.mrr||!h.subscribers||!h.arr||!h.mrrMovements){console.warn("Dashboard charts not fully initialized, skipping update.");return}const t=["1月","2月","3月","4月","5月"],e=v.customers.filter(u=>u.status==="active"),n=e.reduce((u,d)=>u+d.mrr,0),r=e.length,a=[8e4,9e4,115e3,14e4,n],o=[3,3,4,5,r],s=a.map(u=>u*12),m=[3e4,25e3,4e4,5e4,Number((c=document.getElementById("newBusinessMRR").textContent)==null?void 0:c.replace(/[^0-9]/g,""))||0],i=[5e3,1e4,15e3,25e3,Number((l=document.getElementById("expansionMRR").textContent)==null?void 0:l.replace(/[^0-9]/g,""))||0],f=[-1e4,-2e4,-3e4,-5e4,-Math.abs(Number((p=document.getElementById("churnMRR").textContent)==null?void 0:p.replace(/[^0-9]/g,""))||0)];h.mrr&&(h.mrr.data.labels=t,h.mrr.data.datasets[0].data=a,h.mrr.update()),h.subscribers&&(h.subscribers.data.labels=t,h.subscribers.data.datasets[0].data=o,h.subscribers.update()),h.arr&&(h.arr.data.labels=t,h.arr.data.datasets[0].data=s,h.arr.update()),h.mrrMovements&&(h.mrrMovements.data.labels=t,h.mrrMovements.data.datasets[0].data=m.map(Number),h.mrrMovements.data.datasets[1].data=i.map(Number),h.mrrMovements.data.datasets[2].data=f.map(Number),h.mrrMovements.update())}function ge(){var e;const t=(e=document.getElementById("monthlyBalanceChart"))==null?void 0:e.getContext("2d");t&&!h.monthlyBalance&&(h.monthlyBalance=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"収入",data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4,fill:!0},{label:"支出",data:[],borderColor:"#ff3b30",backgroundColor:"rgba(255,59,48,0.1)",tension:.4,fill:!0},{label:"収支",data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4,borderWidth:3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:n=>`${n.dataset.label}: ¥${n.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:!1,ticks:{callback:n=>`¥${(Number(n)/1e6).toFixed(1)}M`}}}}}))}function pe(){if(h.monthlyBalance||ge(),!h.monthlyBalance)return;const t=[],e=[],n=[],r=[],a=new Date;for(let o=5;o>=0;o--){const s=new Date(a.getFullYear(),a.getMonth()-o,1);t.push(`${s.getFullYear()}/${s.getMonth()+1}月`);let m=0,i=0,f=0;v.customers.forEach(u=>{const d=new Date(u.startDate.replace(/\//g,"-"));d.getMonth()===s.getMonth()&&d.getFullYear()===s.getFullYear()&&(m+=u.initialFee),(u.status==="active"||u.status==="churned"&&u.churnDate&&new Date(u.churnDate.replace(/\//g,"-"))>new Date(s.getFullYear(),s.getMonth(),1))&&d<=new Date(s.getFullYear(),s.getMonth()+1,0)&&(f+=u.mrr,i+=u.operationFee)});const c=f+m+i,p=v.expenses.filter(u=>{const d=new Date(u.date.replace(/\//g,"-"));return d.getMonth()===s.getMonth()&&d.getFullYear()===s.getFullYear()&&u.status==="approved"}).reduce((u,d)=>u+d.amount,0);e.push(c),n.push(p),r.push(c-p)}h.monthlyBalance.data.labels=t,h.monthlyBalance.data.datasets[0].data=e,h.monthlyBalance.data.datasets[1].data=n,h.monthlyBalance.data.datasets[2].data=r,h.monthlyBalance.update()}function oe(){var n,r;const t=(n=document.getElementById("cohortChart"))==null?void 0:n.getContext("2d");t&&!h.cohortChart&&(h.cohortChart=new Chart(t,{type:"line",data:{labels:["月1","月2","月3","月4","月5","月6"],datasets:[{label:"2025年1月コホート",data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4,fill:!0},{label:"2025年2月コホート",data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:a=>`${a.dataset.label}: ${a.parsed.y}%`}}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:a=>`${Number(a)}%`}}}}}));const e=(r=document.getElementById("mrrForecastChart"))==null?void 0:r.getContext("2d");e&&!h.mrrForecastChart&&(h.mrrForecastChart=new Chart(e,{type:"line",data:{labels:[],datasets:[{label:"実績MRR",data:[],borderColor:"#0066ff",tension:.4,fill:!0},{label:"予測MRR",data:[],borderColor:"#00c853",borderDash:[5,5],tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:a=>`${a.dataset.label}: ¥${a.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:!0,ticks:{callback:a=>`¥${(Number(a)/1e3).toFixed(0)}K`}}}}}))}function De(){h.cohortChart||oe(),h.cohortChart&&(h.cohortChart.data.datasets[0].data=[100,95,92,90,88,87],h.cohortChart.data.datasets[1].data=[100,96,93,91,90],h.cohortChart.update())}function we(){if(h.mrrForecastChart||oe(),!h.mrrForecastChart)return;const t=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],e=[8e4,9e4,115e3,14e4,215e3],n=e.map(o=>o),r=[...e];for(let o=r.length;o<t.length;o++)r.push(null);let a=n[n.length-1]||215e3;for(let o=e.length;o<t.length;o++)a=a*(1+(.02+Math.random()*.03)),n.push(Math.round(a));n.length>e.length&&e.length>0&&(n[e.length-1]=e[e.length-1]),h.mrrForecastChart.data.labels=t,h.mrrForecastChart.data.datasets[0].data=r,h.mrrForecastChart.data.datasets[1].data=n,h.mrrForecastChart.update()}function se(t){return{starter:"スターター",professional:"プロフェッショナル",enterprise:"エンタープライズ"}[t]||t}function Se(t){const e={active:"active",trial:"trial",churned:"churned",pending:"pending",approved:"active"},n={active:"アクティブ",trial:"トライアル",churned:"解約",pending:"申請中",approved:"承認済"};return`<span class="status-badge ${e[t]||"pending"}">${n[t]||t}</span>`}function A(t){const e=document.getElementById(t);e&&e.classList.remove("active")}function R(t,e){const n=document.createElement("div");n.className=`notification ${e}`,n.textContent=t,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function yt(){var s,m,i,f,c,l,p,u,d,y,D,w,B,L,C,E,M,j,W,G,J,_,U,Z,Q,X,K,ee;document.querySelectorAll(".nav-tab, .sidebar-icon").forEach(x=>{x.addEventListener("click",I=>{const $=I.currentTarget.dataset.tabTarget;$&&Ie($,I.currentTarget)})}),(s=document.getElementById("showAddCustomerModalButton"))==null||s.addEventListener("click",We),(m=document.getElementById("confirmAddCustomerButton"))==null||m.addEventListener("click",()=>{Je().catch(x=>console.error("Error in addCustomer:",x))}),(i=document.getElementById("closeAddCustomerModalButton"))==null||i.addEventListener("click",()=>A("addCustomerModal")),(f=document.getElementById("cancelAddCustomerButton"))==null||f.addEventListener("click",()=>A("addCustomerModal")),(c=document.getElementById("exportCustomersButton"))==null||c.addEventListener("click",Qe),(l=document.getElementById("showImportModalButton"))==null||l.addEventListener("click",Xe),(p=document.getElementById("bulkDeleteCustomersButton"))==null||p.addEventListener("click",()=>{const x=document.querySelectorAll(".customer-select-checkbox:checked"),I=[];x.forEach($=>{const S=$.dataset.customerId;S&&I.push(parseInt(S,10))}),Ue(I).catch($=>console.error("Error in bulkDeleteCustomers:",$))}),(u=document.getElementById("customerSearch"))==null||u.addEventListener("input",H),(d=document.getElementById("statusFilter"))==null||d.addEventListener("change",H),(y=document.getElementById("planFilterSales"))==null||y.addEventListener("change",H);const t=document.getElementById("customerTableBody");t&&t.addEventListener("click",x=>{const I=x.target;if(I.classList.contains("customer-select-checkbox")){const k=I,T=k.closest("tr");T&&T.classList.toggle("customer-row-selected",k.checked),ne();const P=t.querySelectorAll(".customer-select-checkbox"),de=Array.from(P).every(le=>le.checked),te=document.getElementById("selectAllCustomersCheckbox");te&&(te.checked=de&&P.length>0);return}const $=I.closest(".btn-show-detail");if($){const k=$.dataset.customerId;if(k){const T=parseInt(k,10);isNaN(T)||Ze(T)}return}const S=I.closest(".btn-delete-customer");if(S){const k=S.dataset.customerId;if(k){const T=parseInt(k,10);isNaN(T)||_e(T).catch(P=>console.error("Error in deleteCustomer:",P))}return}});const e=document.getElementById("selectAllCustomersCheckbox");e&&e.addEventListener("change",x=>{const I=x.target.checked;document.querySelectorAll("#customerTableBody .customer-select-checkbox").forEach(S=>{S.checked=I;const k=S.closest("tr");k&&k.classList.toggle("customer-row-selected",I)}),ne()}),(D=document.getElementById("closeImportModalButton"))==null||D.addEventListener("click",()=>A("importModal")),(w=document.getElementById("selectFileButton"))==null||w.addEventListener("click",()=>document.getElementById("csvFileInput").click()),(B=document.getElementById("csvFileInput"))==null||B.addEventListener("change",ve);const n=document.getElementById("uploadArea");n&&(n.addEventListener("dragover",x=>{x.preventDefault(),n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>n.classList.remove("drag-over")),n.addEventListener("drop",x=>{var $;x.preventDefault(),n.classList.remove("drag-over");const I=($=x.dataTransfer)==null?void 0:$.files;I&&I.length>0&&ve({target:{files:I}})})),(L=document.getElementById("showAddCampaignModalButton"))==null||L.addEventListener("click",nt),(C=document.getElementById("confirmAddCampaignButton"))==null||C.addEventListener("click",at),(E=document.getElementById("closeAddCampaignModalButton"))==null||E.addEventListener("click",()=>A("addCampaignModal")),(M=document.getElementById("cancelAddCampaignButton"))==null||M.addEventListener("click",()=>A("addCampaignModal"));const r=document.getElementById("leadTableBody");r&&r.addEventListener("click",x=>{const $=x.target.closest(".btn-convert-lead");if($){const S=$.dataset.leadId;if(S){const k=parseInt(S,10);isNaN(k)||tt(k)}}});const a=document.getElementById("csTaskList");a&&a.addEventListener("change",x=>{const I=x.target;if(I.classList.contains("task-checkbox")){const $=I.dataset.taskId;if($){const S=parseInt($,10);isNaN(S)||ct(S)}}}),(j=document.getElementById("showAddExpenseModalButton"))==null||j.addEventListener("click",it),(W=document.getElementById("confirmAddExpenseButton"))==null||W.addEventListener("click",ut),(G=document.getElementById("closeAddExpenseModalButton"))==null||G.addEventListener("click",()=>A("addExpenseModal")),(J=document.getElementById("cancelAddExpenseButton"))==null||J.addEventListener("click",()=>A("addExpenseModal")),(_=document.getElementById("expenseCategoryFinance"))==null||_.addEventListener("change",$e),(U=document.getElementById("balanceViewYear"))==null||U.addEventListener("change",be),(Z=document.getElementById("balanceViewMonth"))==null||Z.addEventListener("change",be);const o=document.getElementById("expenseTableBodyFinance");o&&o.addEventListener("click",x=>{const $=x.target.closest(".btn-delete-expense");if($){const S=$.dataset.expenseId;if(S){const k=parseInt(S,10);isNaN(k)||mt(k)}}}),(Q=document.getElementById("generateReportButton"))==null||Q.addEventListener("click",pt),(X=document.getElementById("downloadMonthlyReport"))==null||X.addEventListener("click",()=>ie("月次")),(K=document.getElementById("downloadQuarterlyReport"))==null||K.addEventListener("click",()=>ie("四半期")),(ee=document.getElementById("downloadAnnualReport"))==null||ee.addEventListener("click",()=>ie("年次")),window.addEventListener("click",x=>{document.querySelectorAll(".modal.active").forEach(I=>{x.target===I&&A(I.id)})})}window.addEventListener("DOMContentLoaded",async()=>{var e;Oe(),yt(),await Pe();const t=((e=document.querySelector(".nav-tab.active"))==null?void 0:e.getAttribute("data-tab-target"))||"home";Ie(t),t==="home"?(Me(),Le()):t==="finance"?(ge(),pe()):t==="subscription"&&(oe(),De(),we())});const ke="https://gta-test1.com/myapp/api",b={customers:[],expenses:[],campaigns:[],leads:[]},g={};function ft(){b.customers=[{id:1,name:"株式会社ABC商事",plan:"professional",mrr:25e3,initialFee:1e5,operationFee:5e4,assignee:"田中太郎",hours:20,region:"関東",industry:"小売業",channel:"Web検索",status:"active",startDate:"2024/03/15",healthScore:85,lastLogin:"2025/05/28",supportTickets:2,npsScore:9,usageRate:92},{id:2,name:"DEF株式会社",plan:"starter",mrr:15e3,initialFee:5e4,operationFee:0,assignee:"佐藤花子",hours:10,region:"関西",industry:"IT",channel:"紹介",status:"trial",startDate:"2025/05/26",healthScore:70,lastLogin:"2025/05/29",supportTickets:0,npsScore:7,usageRate:45},{id:3,name:"GHIコーポレーション",plan:"enterprise",mrr:5e4,initialFee:2e5,operationFee:1e5,assignee:"山田次郎",hours:40,region:"関東",industry:"製造業",channel:"イベント",status:"active",startDate:"2023/08/01",healthScore:95,lastLogin:"2025/05/29",supportTickets:1,npsScore:10,usageRate:98},{id:4,name:"株式会社JKLテクノロジー",plan:"professional",mrr:25e3,initialFee:1e5,operationFee:3e4,assignee:"田中太郎",hours:15,region:"関東",industry:"IT",channel:"Web検索",status:"active",startDate:"2025/01/10",healthScore:75,lastLogin:"2025/05/25",supportTickets:3,npsScore:8,usageRate:78},{id:5,name:"MNO物産",plan:"starter",mrr:15e3,initialFee:5e4,operationFee:0,assignee:"佐藤花子",hours:8,region:"中部",industry:"卸売業",channel:"紹介",status:"active",startDate:"2025/02/20",healthScore:88,lastLogin:"2025/05/27",supportTickets:0,npsScore:9,usageRate:85},{id:6,name:"PQRサービス",plan:"enterprise",mrr:5e4,initialFee:2e5,operationFee:8e4,assignee:"山田次郎",hours:35,region:"関西",industry:"サービス業",channel:"パートナー",status:"active",startDate:"2025/03/05",healthScore:60,lastLogin:"2025/05/20",supportTickets:5,npsScore:6,usageRate:55},{id:7,name:"STUエンタープライズ",plan:"professional",mrr:3e4,initialFee:1e5,operationFee:4e4,assignee:"田中太郎",hours:25,region:"九州",industry:"金融",channel:"広告",status:"active",startDate:"2024/11/15",healthScore:82,lastLogin:"2025/05/28",supportTickets:1,npsScore:8,usageRate:90},{id:8,name:"VWX製薬",plan:"enterprise",mrr:75e3,initialFee:3e5,operationFee:15e4,assignee:"山田次郎",hours:50,region:"関東",industry:"医療",channel:"アウトバウンド",status:"active",startDate:"2024/05/01",healthScore:92,lastLogin:"2025/05/29",supportTickets:2,npsScore:9,usageRate:95}],b.expenses=[{id:1,date:"2025/05/28",name:"LinkedIn広告費",category:"広告宣伝費",subcategory:"SNS広告",amount:2e5,status:"approved"},{id:2,date:"2025/05/25",name:"Google Ads広告費",category:"広告宣伝費",subcategory:"Web広告",amount:15e4,status:"approved"},{id:3,date:"2025/05/24",name:"AWS開発環境構築",category:"研究開発費",subcategory:"開発ツール",amount:85e3,status:"approved"},{id:4,date:"2025/05/23",name:"マーケティング支援業務",category:"業務委託費",subcategory:"マーケティング委託",amount:12e4,status:"approved"},{id:5,date:"2025/05/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:6,date:"2025/05/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:15e5,status:"approved"},{id:7,date:"2025/05/15",name:"新規事業調査費",category:"予備投資費",subcategory:"新規事業開発",amount:25e4,status:"approved"},{id:8,date:"2025/05/10",name:"製品開発費",category:"研究開発費",subcategory:"製品開発",amount:3e5,status:"approved"},{id:9,date:"2025/05/05",name:"エンジニア業務委託",category:"業務委託費",subcategory:"開発委託",amount:45e4,status:"approved"},{id:10,date:"2025/04/25",name:"Facebook広告費",category:"広告宣伝費",subcategory:"SNS広告",amount:12e4,status:"approved"},{id:11,date:"2025/04/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:12,date:"2025/04/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:14e5,status:"approved"},{id:13,date:"2025/04/15",name:"デザイン制作委託",category:"業務委託費",subcategory:"デザイン委託",amount:18e4,status:"approved"},{id:14,date:"2025/04/10",name:"コンテンツ制作費",category:"広告宣伝費",subcategory:"コンテンツマーケティング",amount:25e4,status:"approved"},{id:15,date:"2025/03/25",name:"リスティング広告費",category:"広告宣伝費",subcategory:"Web広告",amount:18e4,status:"approved"},{id:16,date:"2025/03/20",name:"役員報酬",category:"人件費",subcategory:"役員報酬",amount:8e5,status:"approved"},{id:17,date:"2025/03/20",name:"正社員給与",category:"人件費",subcategory:"正社員給与",amount:13e5,status:"approved"},{id:18,date:"2025/03/15",name:"イベント出展費",category:"広告宣伝費",subcategory:"イベント・展示会",amount:35e4,status:"approved"},{id:19,date:"2025/03/10",name:"サーバー費用",category:"研究開発費",subcategory:"開発ツール",amount:12e4,status:"approved"}],b.campaigns=[{id:1,name:"春の新規獲得キャンペーン",channel:"Google Ads",budget:5e5,spent:32e4,leads:45,conversions:8,startDate:"2025/04/01",endDate:"2025/05/31",status:"active"},{id:2,name:"LinkedInターゲティング広告",channel:"LinkedIn",budget:3e5,spent:28e4,leads:23,conversions:5,startDate:"2025/05/01",endDate:"2025/06/30",status:"active"},{id:3,name:"メールナーチャリング",channel:"Email",budget:5e4,spent:3e4,leads:120,conversions:12,startDate:"2025/03/01",endDate:"2025/05/31",status:"active"}],b.leads=[{id:1,company:"XYZ株式会社",contact:"鈴木一郎",email:"suzuki@xyz.co.jp",source:"Google Ads",score:85,status:"hot",createdDate:"2025/05/25"},{id:2,company:"123商事",contact:"高橋花子",email:"takahashi@123.co.jp",source:"LinkedIn",score:70,status:"warm",createdDate:"2025/05/24"},{id:3,company:"テクノロジー研究所",contact:"山本太郎",email:"yamamoto@tech.co.jp",source:"Webフォーム",score:60,status:"warm",createdDate:"2025/05/23"},{id:4,company:"グローバル商社",contact:"佐藤次郎",email:"sato@global.co.jp",source:"イベント",score:90,status:"hot",createdDate:"2025/05/22"},{id:5,company:"イノベーション株式会社",contact:"田中美穂",email:"tanaka@innovation.co.jp",source:"紹介",score:40,status:"cold",createdDate:"2025/05/20"}]}function Re(t,e){const n=document.querySelectorAll(".nav-tab"),r=document.querySelectorAll(".sidebar-icon"),a=document.querySelectorAll(".tab-content");n.forEach(i=>i.classList.remove("active")),r.forEach(i=>i.classList.remove("active")),a.forEach(i=>i.classList.remove("active"));const o=document.getElementById(t);o&&o.classList.add("active");const s=document.querySelector(`.nav-tab[data-tab-target="${t}"]`);s&&s.classList.add("active");const m=document.querySelector(`.sidebar-icon[data-tab-target="${t}"]`);if(m&&m.classList.add("active"),e&&e.classList.contains("sidebar-icon")){const i=document.querySelector(`.nav-tab[data-tab-target="${t}"]`);i&&i.classList.add("active")}if(t==="home")q();else if(t==="sales")Y(),ae();else if(t==="marketing")Te();else if(t==="customer-success")kt();else if(t==="finance"){const i=new Date;document.getElementById("balanceViewYear").value=String(i.getFullYear()),document.getElementById("balanceViewMonth").value=String(i.getMonth()+1),z(),he(),g.monthlyBalance||ye(),setTimeout(()=>fe(),100)}else t==="analytics"?Vt():t==="subscription"&&(Pt(),g.cohortChart||re())}function q(){const t=b.customers.filter(B=>B.status==="active"),e=t.reduce((B,L)=>B+L.mrr,0),n=e*12,r=t.length;document.getElementById("totalMRR").textContent=`¥${e.toLocaleString()}`,document.getElementById("annualRunRate").textContent=`¥${n.toLocaleString()}`,document.getElementById("subscriberCount").textContent=String(r);const a=new Date,o=a.getMonth(),s=a.getFullYear();let m=0;b.customers.forEach(B=>{const L=new Date(B.startDate.replace(/\//g,"-"));L.getMonth()===o&&L.getFullYear()===s&&B.status==="active"&&(m+=B.mrr)});const i=Math.round(e*.05),f=-Math.round(e*.01),c=-Math.round(e*.02),l=m+i+f+c;document.getElementById("newBusinessMRR").textContent=`¥${m.toLocaleString()}`,document.getElementById("expansionMRR").textContent=`¥${i.toLocaleString()}`,document.getElementById("contractionMRR").textContent=`¥${Math.abs(f).toLocaleString()}`,document.getElementById("churnMRR").textContent=`¥${Math.abs(c).toLocaleString()}`,document.getElementById("reactivationMRR").textContent="¥0",document.getElementById("netMRRChange").textContent=`¥${l.toLocaleString()}`,document.getElementById("netMRRChange").style.color=l>=0?"#00c853":"#ff3b30",document.getElementById("scheduledMRRChange").textContent="¥50,000";const p=e-l,u=p>0?l/p*100:m>0?100:0,d=document.getElementById("mrrChangePercent");d.textContent=`${l>=0?"↑":"↓"} ${Math.abs(u).toFixed(1)}% 前月比`,d.className=`metric-change ${l>=0?"positive":"negative"}`;const y=document.getElementById("arrChange");y.textContent=`${l>=0?"↑":"↓"} ${Math.abs(u).toFixed(1)}% 過去30日間`,y.className=`metric-change ${l>=0?"positive":"negative"}`;const D=b.customers.filter(B=>{const L=new Date(B.startDate.replace(/\//g,"-"));return L.getMonth()===o&&L.getFullYear()===s}).length,w=document.getElementById("subscriberChange");w.textContent=`↑ ${D} 新規`,w.className="metric-change positive",vt(),He()}function vt(){const t=document.getElementById("topWinsContent"),e=b.customers.filter(n=>n.status==="active").sort((n,r)=>new Date(r.startDate.replace(/\//g,"-")).getTime()-new Date(n.startDate.replace(/\//g,"-")).getTime()).slice(0,3);e.length>0?(t.innerHTML=e.map(n=>`
            <div style="padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${n.name}</strong>
                        <div style="font-size: 12px; color: #6f767e; margin-top: 4px;">
                            ${ce(n.plan)} - ¥${n.mrr.toLocaleString()}/月
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6f767e;">
                        ${n.startDate}
                    </div>
                </div>
            </div>
        `).join(""),e.length<3&&(t.innerHTML+=`<div class="no-data" style="padding: 10px 0;">${3-e.length}件以上のデータを追加すると充実します</div>`)):t.innerHTML='<div class="no-data">今週の成果はありません</div>'}function Y(){const t=document.getElementById("customerTableBody"),e=document.getElementById("customerSearch").value.toLowerCase(),n=document.getElementById("statusFilter").value,r=document.getElementById("planFilterSales").value,a=b.customers.filter(s=>{const m=s.name.toLowerCase().includes(e),i=!n||s.status===n,f=!r||s.plan===r;return m&&i&&f}),o=document.getElementById("selectAllCustomersCheckbox");if(o&&(o.checked=!1),a.length===0){b.customers.length===0?t.innerHTML='<tr><td colspan="14" class="no-data">顧客データがありません。</td></tr>':t.innerHTML='<tr><td colspan="14" class="no-data">フィルター条件に一致する顧客がいません。</td></tr>',ae();return}t.innerHTML=a.map(s=>`
        <tr data-customer-id="${s.id}">
            <td><input type="checkbox" class="customer-select-checkbox" data-customer-id="${s.id}"></td>
            <td>${s.name}</td>
            <td>${ce(s.plan)}</td>
            <td>¥${s.mrr.toLocaleString()}</td>
            <td>¥${s.initialFee.toLocaleString()}</td>
            <td>¥${s.operationFee.toLocaleString()}</td>
            <td>${s.assignee}</td>
            <td>${s.hours}</td>
            <td>${s.region}</td>
            <td>${s.industry}</td>
            <td>${s.channel}</td>
            <td>${ze(s.status)}</td>
            <td>${s.startDate}</td>
            <td>
                <button class="btn btn-secondary btn-show-detail" data-customer-id="${s.id}">詳細</button>
                <button class="btn btn-secondary btn-delete-customer" data-customer-id="${s.id}" style="color: #ff3b30;">削除</button>
            </td>
        </tr>
    `).join(""),ae()}function bt(){document.getElementById("addCustomerForm").reset(),document.getElementById("addCustomerModal").classList.add("active")}function Fe(){return b.customers.length===0?1:Math.max(...b.customers.map(t=>t.id))+1}async function Ct(){const t=document.getElementById("newCustomerName"),e=document.getElementById("newCustomerPlan"),n=document.getElementById("newCustomerMrr"),r=document.getElementById("newCustomerInitialFee"),a=document.getElementById("newCustomerOperationFee"),o=document.getElementById("newCustomerAssignee"),s=document.getElementById("newCustomerHours"),m=document.getElementById("newCustomerRegion"),i=document.getElementById("newCustomerIndustry"),f=document.getElementById("newCustomerChannel");if(!t.value||!e.value||!n.value||!o.value||!s.value||!m.value||!i.value||!f.value){F("必須項目を全て入力してください。","error");return}const c={id:Fe(),name:t.value,plan:e.value,mrr:parseInt(n.value)||0,initialFee:parseInt(r.value)||0,operationFee:parseInt(a.value)||0,assignee:o.value,hours:parseInt(s.value)||0,region:m.value,industry:i.value,channel:f.value,status:"trial",startDate:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),healthScore:70,lastLogin:new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}).replace(/-/g,"/"),supportTickets:0,npsScore:7,usageRate:50};try{const l=await fetch(`${ke}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!l.ok){const u=await l.text();throw new Error(`サーバーエラー: ${l.status} ${u}`)}const p=await l.json();p.customer_id&&(c.id=p.customer_id),b.customers.push(c),N("addCustomerModal"),Y(),q(),z(),F("顧客情報を保存し、追加しました","success")}catch(l){console.error("顧客情報の保存に失敗しました:",l),F(`顧客情報の保存に失敗しました: ${l.message}`,"error")}}function Et(t){confirm("この顧客を削除してもよろしいですか？")&&(b.customers=b.customers.filter(e=>e.id!==t),Y(),q(),z(),F("顧客を削除しました","success"))}function It(t){if(t.length===0){F("削除する顧客が選択されていません。","error");return}if(confirm(`選択した ${t.length} 件の顧客を削除してもよろしいですか？`)){b.customers=b.customers.filter(n=>!t.includes(n.id)),Y(),q(),z(),F(`${t.length} 件の顧客を削除しました`,"success");const e=document.getElementById("selectAllCustomersCheckbox");e&&(e.checked=!1)}}function Bt(t){const e=b.customers.find(n=>n.id===t);if(e){const n=`顧客ID: ${e.id}
会社名: ${e.name}
プラン: ${ce(e.plan)}
MRR: ¥${e.mrr.toLocaleString()}
初期費用: ¥${e.initialFee.toLocaleString()}
運用代行費: ¥${e.operationFee.toLocaleString()}
担当者: ${e.assignee}
工数: ${e.hours}h/月
地域: ${e.region}
業界: ${e.industry}
獲得チャネル: ${e.channel}
ステータス: ${e.status}
契約開始日: ${e.startDate}
ヘルススコア: ${e.healthScore}%
最終ログイン: ${e.lastLogin}
サポートチケット: ${e.supportTickets}
NPS: ${e.npsScore}
利用率: ${e.usageRate}%`;alert(n),F(`${e.name}の詳細情報を表示しました (コンソールに詳細)`,"success"),console.log("Customer Details:",e)}else F(`顧客ID ${t} が見つかりません。`,"error")}function xt(){const e=[["会社名","プラン","月額料金","初期費用","運用代行費","担当者","工数","地域","業界","獲得チャネル","ステータス","契約開始日"].join(",")];b.customers.forEach(o=>{const s=[o.name,ce(o.plan),o.mrr,o.initialFee,o.operationFee,o.assignee,o.hours,o.region,o.industry,o.channel,o.status,o.startDate];e.push(s.join(","))});const n=e.join(`
`),r=new Blob(["\uFEFF"+n],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(r),a.download=`顧客データ_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),F("顧客データをエクスポートしました","success")}function $t(){document.getElementById("importModal").classList.add("active");const t=document.getElementById("csvFileInput");t&&(t.value="")}function Ce(t){var n;const e=(n=t.target.files)==null?void 0:n[0];if(e&&e.type==="text/csv"){const r=new FileReader;r.onload=a=>{var i,f,c,l,p,u,d,y,D,w,B,L,C;const s=((i=a.target)==null?void 0:i.result).split(`
`).map(E=>E.trim()).filter(E=>E);if(s.length<=1){F("CSVファイルにデータがありません。","error");return}let m=0;for(let E=1;E<s.length;E++){const M=s[E].split(",");if(M.length<12){console.warn(`Skipping row ${E+1} due to insufficient columns: ${s[E]}`);continue}const j={id:Fe(),name:((f=M[0])==null?void 0:f.trim())||"",plan:((c=M[1])==null?void 0:c.trim())||"starter",mrr:parseInt((l=M[2])==null?void 0:l.trim())||0,initialFee:parseInt((p=M[3])==null?void 0:p.trim())||0,operationFee:parseInt((u=M[4])==null?void 0:u.trim())||0,assignee:((d=M[5])==null?void 0:d.trim())||"",hours:parseInt((y=M[6])==null?void 0:y.trim())||0,region:((D=M[7])==null?void 0:D.trim())||"",industry:((w=M[8])==null?void 0:w.trim())||"",channel:((B=M[9])==null?void 0:B.trim())||"",status:((L=M[10])==null?void 0:L.trim())||"trial",startDate:((C=M[11])==null?void 0:C.trim())||new Date().toLocaleDateString("ja-JP").replace(/-/g,"/"),healthScore:70,lastLogin:new Date().toLocaleDateString("ja-JP").replace(/-/g,"/"),supportTickets:0,npsScore:7,usageRate:50};j.name?(b.customers.push(j),m++):console.warn(`Skipping row ${E+1} due to missing name: ${s[E]}`)}N("importModal"),Y(),q(),z(),F(`${m}件のデータをインポートしました`,"success")},r.onerror=()=>{F("ファイル読み込みエラー","error")},r.readAsText(e,"UTF-8")}else F("CSVファイルを選択してください","error")}function ae(){const t=document.getElementById("bulkDeleteCustomersButton");if(!t)return;document.querySelectorAll(".customer-select-checkbox:checked").length>0?t.disabled=!1:t.disabled=!0}function Te(){const t=b.leads.length,e=b.campaigns.reduce((o,s)=>o+s.conversions,0),n=b.campaigns.reduce((o,s)=>o+s.spent,0),r=t>0?(e/t*100).toFixed(1):"0",a=t>0?Math.round(n/t):0;document.getElementById("totalLeads").textContent=String(t),document.getElementById("conversionRate").textContent=`${r}%`,document.getElementById("cplValue").textContent=`¥${a.toLocaleString()}`,document.getElementById("totalLeadsChange").textContent="↑ 0% 前月比",document.getElementById("conversionRateChange").textContent="↑ 0% 前月比",document.getElementById("cplValueChange").textContent="↓ 0% 前月比",Mt(),Ae()}function Mt(){const t=document.getElementById("campaignList");if(b.campaigns.length===0){t.innerHTML='<div class="no-data">キャンペーンがありません。</div>';return}t.innerHTML=b.campaigns.map(e=>{const n=e.spent>0?((e.conversions*25e3-e.spent)/e.spent*100).toFixed(0):"0",r=e.budget>0?Math.min(100,e.spent/e.budget*100).toFixed(0):"0";return`
            <div class="campaign-card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="font-size: 16px; margin-bottom: 8px;">${e.name}</h4>
                        <div style="font-size: 12px; color: #6f767e;">
                            ${e.channel} | ${e.startDate} - ${e.endDate}
                        </div>
                    </div>
                    <span class="status-badge ${e.status==="active"?"active":"pending"}">${e.status}</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 16px;">
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">予算消化</div>
                        <div style="font-weight: 600;">¥${e.spent.toLocaleString()} / ¥${e.budget.toLocaleString()}</div>
                        <div class="progress-bar" style="margin-top: 4px;">
                            <div class="progress-fill" style="width: ${r}%"></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">リード数</div>
                        <div style="font-weight: 600;">${e.leads}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">コンバージョン</div>
                        <div style="font-weight: 600;">${e.conversions}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6f767e;">ROI</div>
                        <div style="font-weight: 600; color: ${parseFloat(n)>=0?"#00c853":"#ff3b30"};">${n}%</div>
                    </div>
                </div>
            </div>
        `}).join("")}function Ae(){const t=document.getElementById("leadTableBody");if(b.leads.length===0){t.innerHTML='<tr><td colspan="8" class="no-data">リードがいません。</td></tr>';return}t.innerHTML=b.leads.map(e=>`
        <tr>
            <td>${e.company}</td>
            <td>${e.contact}</td>
            <td>${e.email}</td>
            <td>${e.source}</td>
            <td>${Lt(e.score,e.status)}</td>
            <td><span class="status-badge pending">${e.status==="converted"?"商談化済":"新規"}</span></td>
            <td>${e.createdDate}</td>
            <td>
                <button class="btn btn-secondary btn-convert-lead" data-lead-id="${e.id}" ${e.status==="converted"?" disabled":""}>商談化</button>
            </td>
        </tr>
    `).join("")}function Lt(t,e){return`<span class="lead-score ${e}">${t}</span>`}function Dt(t){const e=b.leads.find(n=>n.id===t);e&&e.status!=="converted"?(e.status="converted",F(`${e.company}を商談化しました`,"success"),Ae()):e&&e.status==="converted"&&F(`${e.company}は既に商談化されています`,"error")}function wt(){document.getElementById("addCampaignForm").reset(),document.getElementById("campaignStartDate").value=new Date().toISOString().split("T")[0],document.getElementById("addCampaignModal").classList.add("active")}function St(){const t={id:b.campaigns.length>0?Math.max(...b.campaigns.map(e=>e.id))+1:1,name:document.getElementById("campaignName").value,channel:document.getElementById("campaignChannel").value,budget:parseInt(document.getElementById("campaignBudget").value)||0,spent:0,leads:0,conversions:0,startDate:document.getElementById("campaignStartDate").value.replace(/-/g,"/"),endDate:document.getElementById("campaignEndDate").value.replace(/-/g,"/"),status:"active"};b.campaigns.push(t),N("addCampaignModal"),Te(),F("キャンペーンを作成しました","success")}function kt(){const e=b.customers.filter(o=>o.status==="active").map(o=>o.npsScore).filter(o=>typeof o=="number"),n=e.filter(o=>o>=9).length,r=e.filter(o=>o<=6).length,a=e.length>0?Math.round((n-r)/e.length*100):0;document.getElementById("npsScore").textContent=String(a),document.getElementById("avgResponseTime").textContent="2.5h",document.getElementById("csat").textContent="92%",document.getElementById("npsScoreChange").textContent="↑ 0 前四半期比",document.getElementById("avgResponseTimeChange").textContent="↓ 0% 前月比",document.getElementById("csatChange").textContent="↑ 0% 前月比",Rt(),Ft()}function Rt(){const t=document.getElementById("healthScoreTableBody"),e=b.customers.filter(n=>n.status==="active");if(e.length===0){t.innerHTML='<tr><td colspan="7" class="no-data">アクティブな顧客がいません。</td></tr>';return}t.innerHTML=e.map(n=>{const r=n.healthScore>=80?"healthy":n.healthScore>=60?"at-risk":"critical";return`
            <tr>
                <td>${n.name}</td>
                <td><div class="health-score"><span class="health-dot ${r}"></span>${n.healthScore}%</div></td>
                <td>${n.usageRate}%</td>
                <td>${n.lastLogin}</td>
                <td>${n.supportTickets}</td>
                <td>${n.assignee}</td>
                <td>${r==="at-risk"?"要フォローアップ":r==="critical"?"緊急対応必要":"定期チェック"}</td>
            </tr>
        `}).join("")}function Ft(){const t=[{id:1,title:"PQRサービスのヘルススコア改善施策実施",due:"2025/06/10",completed:!1},{id:2,title:"GHIコーポレーションの四半期レビュー",due:"2025/06/15",completed:!1},{id:3,title:"JKLテクノロジーのオンボーディング完了確認",due:"2025/06/01",completed:!0}],e=document.getElementById("csTaskList");if(t.length===0){e.innerHTML='<div class="no-data">タスクがありません。</div>';return}e.innerHTML=t.map(n=>`
        <div class="task-card">
            <input type="checkbox" class="task-checkbox" id="task-${n.id}" ${n.completed?"checked":""} data-task-id="${n.id}">
            <label for="task-${n.id}" style="flex: 1; ${n.completed?"text-decoration: line-through; color: #6f767e;":""}">
                <div>${n.title}</div>
                <div style="font-size: 12px; color: #6f767e; margin-top: 4px;">期限: ${n.due}</div>
            </label>
        </div>
    `).join("")}function Tt(t){F(`タスク ${t} のステータスを更新しました`,"success")}function z(t,e){var B,L;const n=new Date,r=t||parseInt((B=document.getElementById("balanceViewYear"))==null?void 0:B.value)||n.getFullYear(),a=e!==null?e:parseInt((L=document.getElementById("balanceViewMonth"))==null?void 0:L.value)-1;let o=0,s=0,m=0,i=0,f=0,c=0;b.customers.forEach(C=>{const E=new Date(C.startDate.replace(/\//g,"-"));E.getMonth()===a&&E.getFullYear()===r&&(o+=C.initialFee,i++),(C.status==="active"||C.status==="churned"&&C.churnDate&&new Date(C.churnDate.replace(/\//g,"-"))>new Date(r,a,1))&&E<=new Date(r,a+1,0)&&(m+=C.mrr,s+=C.operationFee,f++,C.operationFee>0&&c++)});const l=m+o+s,p=b.expenses.filter(C=>{const E=new Date(C.date.replace(/\//g,"-"));return E.getMonth()===a&&E.getFullYear()===r&&C.status==="approved"}),u=p.reduce((C,E)=>C+E.amount,0),d=l-u,y=l>0?(d/l*100).toFixed(1):"0";document.getElementById("monthlyMRRIncome").textContent=`¥${m.toLocaleString()}`,document.getElementById("mrrIncomeDetail").textContent=`アクティブ顧客: ${f}社`,document.getElementById("monthlyInitialFees").textContent=`¥${o.toLocaleString()}`,document.getElementById("initialFeeCount").textContent=`新規${i}件`,document.getElementById("monthlyOperationFees").textContent=`¥${s.toLocaleString()}`,document.getElementById("operationFeeChangeFinance").textContent=`対象顧客: ${c}社`,document.getElementById("monthlyTotalIncome").textContent=`¥${l.toLocaleString()}`,document.getElementById("monthlyTotalExpense").textContent=`¥${u.toLocaleString()}`;const D=document.getElementById("monthlyBalance");D.textContent=`¥${d.toLocaleString()}`,D.className=`metric-value ${d>=0?"":"negative"}`;const w=document.getElementById("balanceChange");return w.textContent=`利益率: ${y}%`,w.className=`metric-change ${d>=0?"positive":"negative"}`,At(p),Nt(l,m,o,s,p),{totalIncome:l,totalExpense:u,balance:d}}function At(t){const e={};t.forEach(a=>{e[a.category]=(e[a.category]||0)+a.amount});const n=document.getElementById("expenseCategoryBreakdown"),r=t.reduce((a,o)=>a+o.amount,0);if(Object.keys(e).length===0){n.innerHTML='<div class="no-data">今月の経費データがありません。</div>';return}n.innerHTML=Object.entries(e).sort(([,a],[,o])=>o-a).map(([a,o])=>{const s=r>0?(o/r*100).toFixed(1):"0";return`
                <div style="background: #f8f9fb; padding: 16px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6f767e; margin-bottom: 4px;">${a}</div>
                    <div style="font-size: 20px; font-weight: 600; color: #1a1d1f;">¥${o.toLocaleString()}</div>
                    <div style="font-size: 12px; color: #6f767e;">${s}%</div>
                </div>`}).join("")}function Nt(t,e,n,r,a){const o=document.getElementById("balanceTableBody"),s=[];e>0&&s.push({name:"月額利用料（MRR）",category:"売上高",income:e,expense:0}),n>0&&s.push({name:"初期導入費用",category:"売上高",income:n,expense:0}),r>0&&s.push({name:"運用代行費",category:"売上高",income:r,expense:0});const m={};a.forEach(c=>{m[c.category]=(m[c.category]||0)+c.amount}),Object.entries(m).forEach(([c,l])=>{s.push({name:c,category:"経費",income:0,expense:l})}),s.length===0?o.innerHTML='<tr><td colspan="5" class="no-data">収支データがありません。</td></tr>':o.innerHTML=s.map(c=>{const l=c.income-c.expense;return`
                <tr>
                    <td>${c.name}</td>
                    <td>${c.category}</td>
                    <td>${c.income>0?`¥${c.income.toLocaleString()}`:"-"}</td>
                    <td>${c.expense>0?`¥${c.expense.toLocaleString()}`:"-"}</td>
                    <td class="${l>=0?"positive":"negative"}">¥${l.toLocaleString()}</td>
                </tr>`}).join("");const i=a.reduce((c,l)=>c+l.amount,0);document.getElementById("totalIncomeFooter").textContent=`¥${t.toLocaleString()}`,document.getElementById("totalExpenseFooter").textContent=`¥${i.toLocaleString()}`;const f=document.getElementById("totalBalanceFooter");f.textContent=`¥${(t-i).toLocaleString()}`,f.className=t-i>=0?"positive":"negative"}function he(){const t=document.getElementById("expenseTableBodyFinance");if(b.expenses.length===0){t.innerHTML='<tr><td colspan="6" class="no-data">経費データがありません。</td></tr>';return}t.innerHTML=b.expenses.sort((e,n)=>new Date(n.date).getTime()-new Date(e.date).getTime()).map(e=>`
        <tr>
            <td>${e.date}</td>
            <td>${e.name}</td>
            <td>${e.category}${e.subcategory?` - ${e.subcategory}`:""}</td>
            <td>¥${e.amount.toLocaleString()}</td>
            <td>${ze(e.status)}</td>
            <td><button class="btn btn-secondary btn-delete-expense" data-expense-id="${e.id}" style="color: #ff3b30;">削除</button></td>
        </tr>
    `).join("")}function jt(){document.getElementById("addExpenseFormFinance").reset(),document.getElementById("expenseDate").value=new Date().toISOString().split("T")[0],Ne(),document.getElementById("addExpenseModal").classList.add("active")}function Ht(){const t={id:b.expenses.length>0?Math.max(...b.expenses.map(e=>e.id))+1:1,date:document.getElementById("expenseDate").value.replace(/-/g,"/"),name:document.getElementById("expenseName").value,category:document.getElementById("expenseCategoryFinance").value,subcategory:document.getElementById("expenseSubcategory").value||"",amount:parseInt(document.getElementById("expenseAmount").value)||0,status:"pending"};if(!t.name||!t.category||isNaN(t.amount)||t.amount<=0){F("必須項目を入力してください。金額は0より大きい値を入力してください。","error");return}b.expenses.push(t),N("addExpenseModal"),he(),z(),F("経費を登録しました","success")}function Yt(t){confirm("この経費を削除してもよろしいですか？")&&(b.expenses=b.expenses.filter(e=>e.id!==t),he(),z(),F("経費を削除しました","success"))}function Ne(){const t=document.getElementById("expenseCategoryFinance").value,e=document.getElementById("subcategoryGroup"),n=document.getElementById("expenseSubcategory"),r={広告宣伝費:["Web広告","SNS広告","オフライン広告","PR・広報","イベント・展示会","コンテンツマーケティング"],業務委託費:["開発委託","デザイン委託","コンサルティング","マーケティング委託","カスタマーサポート委託","その他委託"],人件費:["役員報酬","正社員給与","契約社員給与","アルバイト給与","賞与","社会保険料","退職金"],研究開発費:["製品開発","技術研究","プロトタイプ制作","特許申請","ライセンス取得","開発ツール"],予備投資費:["設備投資","システム投資","事業拡大準備","新規事業開発","M&A関連","緊急対応費"]};t&&r[t]?(e.style.display="block",n.innerHTML='<option value="">選択してください</option>'+r[t].map(a=>`<option value="${a}">${a}</option>`).join("")):(e.style.display="none",n.innerHTML='<option value="">選択してください</option>',n.value="")}function Ee(){const t=parseInt(document.getElementById("balanceViewYear").value),e=parseInt(document.getElementById("balanceViewMonth").value)-1;z(t,e),fe()}function Vt(){const t=b.customers.filter(d=>d.status==="active"),e=t.reduce((d,y)=>d+y.mrr,0),n=t.length>0?e/t.length:0,r=b.campaigns.reduce((d,y)=>{const D=new Date(y.startDate.replace(/\//g,"-")),w=new Date(y.endDate.replace(/\//g,"-")),B=new Date;return D<=B&&w>=B?d+y.spent/((w.getTime()-D.getTime())/(1e3*3600*24*30)||1):d},0),a=45e4,o=b.customers.filter(d=>{const y=new Date(d.startDate.replace(/\//g,"-")),D=new Date;return y.getFullYear()===D.getFullYear()&&y.getMonth()===D.getMonth()}).length||1,s=(r+a)/o,m=24,i=n*m,f=s>0?i/s:0;document.getElementById("cacValue").textContent=`¥${Math.round(s).toLocaleString()}`,document.getElementById("ltvValue").textContent=`¥${Math.round(i).toLocaleString()}`,document.getElementById("ltvCacRatio").textContent=f.toFixed(1),document.getElementById("cacValueChange").textContent="↓ 0% 前月比",document.getElementById("ltvValueChange").textContent="↑ 0% 前月比",document.getElementById("ltvCacRatioChange").textContent="↑ 0 前月比";const c=t.filter(d=>d.plan==="starter"),l=t.filter(d=>d.plan==="professional"),p=t.filter(d=>d.plan==="enterprise");document.getElementById("starterMetrics").textContent=`¥${c.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("starterMetricsCount").textContent=`顧客数: ${c.length}`,document.getElementById("professionalMetrics").textContent=`¥${l.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("professionalMetricsCount").textContent=`顧客数: ${l.length}`,document.getElementById("enterpriseMetrics").textContent=`¥${p.reduce((d,y)=>d+y.mrr,0).toLocaleString()}`,document.getElementById("enterpriseMetricsCount").textContent=`顧客数: ${p.length}`;const u=document.getElementById("ltvAnalysisTableBody");if(t.length===0){u.innerHTML='<tr><td colspan="5" class="no-data">アクティブな顧客がいません。</td></tr>';return}u.innerHTML=t.map(d=>{const y=new Date(d.startDate.replace(/\//g,"-")),w=Math.max(0,Math.floor((new Date().getTime()-y.getTime())/(1e3*60*60*24*30.4375))),B=d.mrr*w+d.initialFee,L=d.mrr*m,C=d.healthScore<60?"critical":d.healthScore<80?"at-risk":"healthy",E=C==="critical"?"churned":C==="at-risk"?"pending":"active",M=C==="critical"?"高":C==="at-risk"?"中":"低";return`
            <tr>
                <td>${d.name}</td>
                <td>${w}ヶ月</td>
                <td>¥${B.toLocaleString()}</td>
                <td>¥${L.toLocaleString()}</td>
                <td><span class="status-badge ${E}">${M}</span></td>
            </tr>
        `}).join("")}function zt(){F("レポートを生成中...","success"),setTimeout(()=>F("月次レポートが生成されました","success"),2e3)}function ue(t){F(`${t}レポートをダウンロード中...`,"success")}function Pt(){const t=b.customers.filter(c=>c.status==="active"),e=t.reduce((c,l)=>c+l.mrr,0),n=e*12,r=100+(Math.random()*10-5),a=b.customers.filter(c=>{if(c.status!=="churned"||!c.churnDate)return!1;const l=new Date(c.churnDate.replace(/\//g,"-")),p=new Date,u=new Date(p.getFullYear(),p.getMonth()-1,1),d=new Date(p.getFullYear(),p.getMonth(),0);return l>=u&&l<=d}).length,o=b.customers.filter(c=>{const l=new Date(c.startDate.replace(/\//g,"-")),p=new Date,u=new Date(p.getFullYear(),p.getMonth()-1,1);return l<u&&(c.status==="active"||c.status==="churned"&&c.churnDate&&new Date(c.churnDate.replace(/\//g,"-"))>=u)}).length,s=o>0?a/o*100:0,m=t.length>0?e/t.length:0;let i=0;t.forEach(c=>{const l=new Date(c.startDate.replace(/\//g,"-")),p=c.status==="churned"&&c.churnDate?new Date(c.churnDate.replace(/\//g,"-")):new Date;i+=Math.max(0,Math.floor((p.getTime()-l.getTime())/(1e3*60*60*24*30.4375)))});const f=t.length>0?Math.round(i/t.length):0;document.getElementById("subMRR").textContent=`¥${e.toLocaleString()}`,document.getElementById("subARR").textContent=`¥${n.toLocaleString()}`,document.getElementById("nrr").textContent=`${r.toFixed(0)}%`,document.getElementById("monthlyChurnRate").textContent=`${s.toFixed(1)}%`,document.getElementById("arpa").textContent=`¥${Math.round(m).toLocaleString()}`,document.getElementById("avgRetentionMonths").textContent=`${f}ヶ月`,document.getElementById("subMRRChange").textContent="↑ 0% 前月比",document.getElementById("subARRChange").textContent="↑ 0% 前年比",document.getElementById("nrrChange").textContent="↑ 0% 前四半期比",document.getElementById("monthlyChurnRateChange").textContent="↓ 0% 前月比",document.getElementById("arpaChange").textContent="↑ 0% 前月比",document.getElementById("avgRetentionMonthsDetail").textContent="業界平均: 24ヶ月",g.cohortChart&&Ye(),g.mrrForecastChart&&Ve()}function je(){var a,o,s,m;g.mrr&&(g.mrr.destroy(),g.mrr=void 0),g.subscribers&&(g.subscribers.destroy(),g.subscribers=void 0),g.arr&&(g.arr.destroy(),g.arr=void 0),g.mrrMovements&&(g.mrrMovements.destroy(),g.mrrMovements=void 0);const t=(a=document.getElementById("mrrChart"))==null?void 0:a.getContext("2d");t&&(g.mrr=new Chart(t,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const e=(o=document.getElementById("subscribersChart"))==null?void 0:o.getContext("2d");e&&(g.subscribers=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const n=(s=document.getElementById("arrChart"))==null?void 0:s.getContext("2d");n&&(g.arr=new Chart(n,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}}));const r=(m=document.getElementById("mrrMovementsChart"))==null?void 0:m.getContext("2d");r&&(g.mrrMovements=new Chart(r,{type:"bar",data:{labels:[],datasets:[{label:"新規",data:[],backgroundColor:"#00c853"},{label:"拡張",data:[],backgroundColor:"#0066ff"},{label:"解約",data:[],backgroundColor:"#ff3b30"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"}},scales:{x:{stacked:!0},y:{stacked:!0,ticks:{callback:i=>`¥${(Number(i)/1e3).toLocaleString()}k`}}}}}))}function He(){var c,l,p;if((!g.mrr||!g.subscribers||!g.arr||!g.mrrMovements)&&je(),!g.mrr||!g.subscribers||!g.arr||!g.mrrMovements){console.warn("Dashboard charts not fully initialized, skipping update.");return}const t=["1月","2月","3月","4月","5月"],e=b.customers.filter(u=>u.status==="active"),n=e.reduce((u,d)=>u+d.mrr,0),r=e.length,a=[8e4,9e4,115e3,14e4,n],o=[3,3,4,5,r],s=a.map(u=>u*12),m=[3e4,25e3,4e4,5e4,Number((c=document.getElementById("newBusinessMRR").textContent)==null?void 0:c.replace(/[^0-9]/g,""))||0],i=[5e3,1e4,15e3,25e3,Number((l=document.getElementById("expansionMRR").textContent)==null?void 0:l.replace(/[^0-9]/g,""))||0],f=[-1e4,-2e4,-3e4,-5e4,-Math.abs(Number((p=document.getElementById("churnMRR").textContent)==null?void 0:p.replace(/[^0-9]/g,""))||0)];g.mrr&&(g.mrr.data.labels=t,g.mrr.data.datasets[0].data=a,g.mrr.update()),g.subscribers&&(g.subscribers.data.labels=t,g.subscribers.data.datasets[0].data=o,g.subscribers.update()),g.arr&&(g.arr.data.labels=t,g.arr.data.datasets[0].data=s,g.arr.update()),g.mrrMovements&&(g.mrrMovements.data.labels=t,g.mrrMovements.data.datasets[0].data=m.map(Number),g.mrrMovements.data.datasets[1].data=i.map(Number),g.mrrMovements.data.datasets[2].data=f.map(Number),g.mrrMovements.update())}function ye(){var e;g.monthlyBalance&&(g.monthlyBalance.destroy(),g.monthlyBalance=void 0);const t=(e=document.getElementById("monthlyBalanceChart"))==null?void 0:e.getContext("2d");t&&(g.monthlyBalance=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"収入",data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4,fill:!0},{label:"支出",data:[],borderColor:"#ff3b30",backgroundColor:"rgba(255,59,48,0.1)",tension:.4,fill:!0},{label:"収支",data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4,borderWidth:3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:n=>`${n.dataset.label}: ¥${n.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:!1,ticks:{callback:n=>`¥${(Number(n)/1e6).toFixed(1)}M`}}}}}))}function fe(){if(g.monthlyBalance||ye(),!g.monthlyBalance)return;const t=[],e=[],n=[],r=[],a=new Date;for(let o=5;o>=0;o--){const s=new Date(a.getFullYear(),a.getMonth()-o,1);t.push(`${s.getFullYear()}/${s.getMonth()+1}月`);let m=0,i=0,f=0;b.customers.forEach(u=>{const d=new Date(u.startDate.replace(/\//g,"-"));d.getMonth()===s.getMonth()&&d.getFullYear()===s.getFullYear()&&(m+=u.initialFee),(u.status==="active"||u.status==="churned"&&u.churnDate&&new Date(u.churnDate.replace(/\//g,"-"))>new Date(s.getFullYear(),s.getMonth(),1))&&d<=new Date(s.getFullYear(),s.getMonth()+1,0)&&(f+=u.mrr,i+=u.operationFee)});const c=f+m+i,p=b.expenses.filter(u=>{const d=new Date(u.date.replace(/\//g,"-"));return d.getMonth()===s.getMonth()&&d.getFullYear()===s.getFullYear()&&u.status==="approved"}).reduce((u,d)=>u+d.amount,0);e.push(c),n.push(p),r.push(c-p)}g.monthlyBalance.data.labels=t,g.monthlyBalance.data.datasets[0].data=e,g.monthlyBalance.data.datasets[1].data=n,g.monthlyBalance.data.datasets[2].data=r,g.monthlyBalance.update()}function re(){var n,r;g.cohortChart&&(g.cohortChart.destroy(),g.cohortChart=void 0),g.mrrForecastChart&&(g.mrrForecastChart.destroy(),g.mrrForecastChart=void 0);const t=(n=document.getElementById("cohortChart"))==null?void 0:n.getContext("2d");t&&(g.cohortChart=new Chart(t,{type:"line",data:{labels:["月1","月2","月3","月4","月5","月6"],datasets:[{label:"2025年1月コホート",data:[],borderColor:"#0066ff",backgroundColor:"rgba(0,102,255,0.1)",tension:.4,fill:!0},{label:"2025年2月コホート",data:[],borderColor:"#00c853",backgroundColor:"rgba(0,200,83,0.1)",tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:a=>`${a.dataset.label}: ${a.parsed.y}%`}}},scales:{y:{beginAtZero:!0,max:100,ticks:{callback:a=>`${Number(a)}%`}}}}}));const e=(r=document.getElementById("mrrForecastChart"))==null?void 0:r.getContext("2d");e&&(g.mrrForecastChart=new Chart(e,{type:"line",data:{labels:[],datasets:[{label:"実績MRR",data:[],borderColor:"#0066ff",tension:.4,fill:!0},{label:"予測MRR",data:[],borderColor:"#00c853",borderDash:[5,5],tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:a=>`${a.dataset.label}: ¥${a.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:!0,ticks:{callback:a=>`¥${(Number(a)/1e3).toFixed(0)}K`}}}}}))}function Ye(){g.cohortChart||re(),g.cohortChart&&(g.cohortChart.data.datasets[0].data=[100,95,92,90,88,87],g.cohortChart.data.datasets[1].data=[100,96,93,91,90],g.cohortChart.update())}function Ve(){if(g.mrrForecastChart||re(),!g.mrrForecastChart)return;const t=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],e=[8e4,9e4,115e3,14e4,215e3],n=e.map(o=>o),r=[...e];for(let o=r.length;o<t.length;o++)r.push(null);let a=n[n.length-1]||215e3;for(let o=e.length;o<t.length;o++)a=a*(1+(.02+Math.random()*.03)),n.push(Math.round(a));n.length>e.length&&e.length>0&&(n[e.length-1]=e[e.length-1]),g.mrrForecastChart.data.labels=t,g.mrrForecastChart.data.datasets[0].data=r,g.mrrForecastChart.data.datasets[1].data=n,g.mrrForecastChart.update()}function ce(t){return{starter:"スターター",professional:"プロフェッショナル",enterprise:"エンタープライズ"}[t]||t}function ze(t){const e={active:"active",trial:"trial",churned:"churned",pending:"pending",approved:"active"},n={active:"アクティブ",trial:"トライアル",churned:"解約",pending:"申請中",approved:"承認済"};return`<span class="status-badge ${e[t]||"pending"}">${n[t]||t}</span>`}function N(t){const e=document.getElementById(t);e&&e.classList.remove("active")}function F(t,e){const n=document.createElement("div");n.className=`notification ${e}`,n.textContent=t,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function Ot(){var s,m,i,f,c,l,p,u,d,y,D,w,B,L,C,E,M,j,W,G,J,_,U,Z,Q,X,K,ee;document.querySelectorAll(".nav-tab, .sidebar-icon").forEach(x=>{x.addEventListener("click",I=>{const $=I.currentTarget.dataset.tabTarget;$&&Re($,I.currentTarget)})}),(s=document.getElementById("showAddCustomerModalButton"))==null||s.addEventListener("click",bt),(m=document.getElementById("confirmAddCustomerButton"))==null||m.addEventListener("click",Ct),(i=document.getElementById("closeAddCustomerModalButton"))==null||i.addEventListener("click",()=>N("addCustomerModal")),(f=document.getElementById("cancelAddCustomerButton"))==null||f.addEventListener("click",()=>N("addCustomerModal")),(c=document.getElementById("exportCustomersButton"))==null||c.addEventListener("click",xt),(l=document.getElementById("showImportModalButton"))==null||l.addEventListener("click",$t),(p=document.getElementById("bulkDeleteCustomersButton"))==null||p.addEventListener("click",()=>{const x=document.querySelectorAll(".customer-select-checkbox:checked"),I=[];x.forEach($=>{const S=$.dataset.customerId;S&&I.push(parseInt(S,10))}),It(I)}),(u=document.getElementById("customerSearch"))==null||u.addEventListener("input",Y),(d=document.getElementById("statusFilter"))==null||d.addEventListener("change",Y),(y=document.getElementById("planFilterSales"))==null||y.addEventListener("change",Y);const t=document.getElementById("customerTableBody");t&&t.addEventListener("click",x=>{const I=x.target;if(I.classList.contains("customer-select-checkbox")){const k=I,T=k.closest("tr");T&&T.classList.toggle("customer-row-selected",k.checked),ae();const P=t.querySelectorAll(".customer-select-checkbox"),de=Array.from(P).every(le=>le.checked),te=document.getElementById("selectAllCustomersCheckbox");te&&(te.checked=de&&P.length>0);return}const $=I.closest(".btn-show-detail");if($){const k=$.dataset.customerId;if(k){const T=parseInt(k,10);isNaN(T)||Bt(T)}return}const S=I.closest(".btn-delete-customer");if(S){const k=S.dataset.customerId;if(k){const T=parseInt(k,10);isNaN(T)||Et(T)}return}});const e=document.getElementById("selectAllCustomersCheckbox");e&&e.addEventListener("change",x=>{const I=x.target.checked;document.querySelectorAll("#customerTableBody .customer-select-checkbox").forEach(S=>{S.checked=I;const k=S.closest("tr");k&&k.classList.toggle("customer-row-selected",I)}),ae()}),(D=document.getElementById("closeImportModalButton"))==null||D.addEventListener("click",()=>N("importModal")),(w=document.getElementById("selectFileButton"))==null||w.addEventListener("click",()=>document.getElementById("csvFileInput").click()),(B=document.getElementById("csvFileInput"))==null||B.addEventListener("change",Ce);const n=document.getElementById("uploadArea");n&&(n.addEventListener("dragover",x=>{x.preventDefault(),n.classList.add("drag-over")}),n.addEventListener("dragleave",()=>n.classList.remove("drag-over")),n.addEventListener("drop",x=>{var $;x.preventDefault(),n.classList.remove("drag-over");const I=($=x.dataTransfer)==null?void 0:$.files;I&&I.length>0&&Ce({target:{files:I}})})),(L=document.getElementById("showAddCampaignModalButton"))==null||L.addEventListener("click",wt),(C=document.getElementById("confirmAddCampaignButton"))==null||C.addEventListener("click",St),(E=document.getElementById("closeAddCampaignModalButton"))==null||E.addEventListener("click",()=>N("addCampaignModal")),(M=document.getElementById("cancelAddCampaignButton"))==null||M.addEventListener("click",()=>N("addCampaignModal"));const r=document.getElementById("leadTableBody");r&&r.addEventListener("click",x=>{const $=x.target.closest(".btn-convert-lead");if($){const S=$.dataset.leadId;if(S){const k=parseInt(S,10);isNaN(k)||Dt(k)}}});const a=document.getElementById("csTaskList");a&&a.addEventListener("change",x=>{const I=x.target;if(I.classList.contains("task-checkbox")){const $=I.dataset.taskId;if($){const S=parseInt($,10);isNaN(S)||Tt(S)}}}),(j=document.getElementById("showAddExpenseModalButton"))==null||j.addEventListener("click",jt),(W=document.getElementById("confirmAddExpenseButton"))==null||W.addEventListener("click",Ht),(G=document.getElementById("closeAddExpenseModalButton"))==null||G.addEventListener("click",()=>N("addExpenseModal")),(J=document.getElementById("cancelAddExpenseButton"))==null||J.addEventListener("click",()=>N("addExpenseModal")),(_=document.getElementById("expenseCategoryFinance"))==null||_.addEventListener("change",Ne),(U=document.getElementById("balanceViewYear"))==null||U.addEventListener("change",Ee),(Z=document.getElementById("balanceViewMonth"))==null||Z.addEventListener("change",Ee);const o=document.getElementById("expenseTableBodyFinance");o&&o.addEventListener("click",x=>{const $=x.target.closest(".btn-delete-expense");if($){const S=$.dataset.expenseId;if(S){const k=parseInt(S,10);isNaN(k)||Yt(k)}}}),(Q=document.getElementById("generateReportButton"))==null||Q.addEventListener("click",zt),(X=document.getElementById("downloadMonthlyReport"))==null||X.addEventListener("click",()=>ue("月次")),(K=document.getElementById("downloadQuarterlyReport"))==null||K.addEventListener("click",()=>ue("四半期")),(ee=document.getElementById("downloadAnnualReport"))==null||ee.addEventListener("click",()=>ue("年次")),window.addEventListener("click",x=>{document.querySelectorAll(".modal.active").forEach(I=>{x.target===I&&N(I.id)})})}async function qt(){try{const t=await fetch(`${ke}/customers`);if(t.ok){const e=await t.json();e.status==="success"&&e.customers&&(b.customers=e.customers,console.log(`Loaded ${e.customers.length} customers from database`),Y(),q(),z())}}catch(t){console.error("Failed to load customers from database:",t)}}window.addEventListener("DOMContentLoaded",async()=>{var e;ft(),Ot(),await qt();const t=((e=document.querySelector(".nav-tab.active"))==null?void 0:e.getAttribute("data-tab-target"))||"home";Re(t),t==="home"?(je(),He()):t==="finance"?(ye(),fe()):t==="subscription"&&(re(),Ye(),Ve())});
